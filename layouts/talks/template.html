{{ define "title" }}{{ .Title }}{{ end }}

{{ define "css" }}

{{ if site.Params.customSyntaxHighlighting }}
<link rel="stylesheet" data-custom-syntax-highlighting />
<style>
  .chroma {
    padding: 1em;
    background-color: var(--dream-pre-bg, #f5f5f5);
    border-radius: .5em;
    overflow: auto;
  }

  html.dark .chroma {
    background-color: var(--dream-pre-bg-dark, #262626);
  }
</style>
{{ else }}
<style>
  pre {
    padding: 1em;
    overflow: auto;
  }
</style>
{{ end }}

{{ end }}

{{ define "main" }}
{{/* Get all talks with this template */}}
{{ $talkName := .Params.talk }}
{{ $relatedTalks := slice }}
{{ range where (where site.RegularPages "Section" "talks") ".Params.talk" $talkName }}
  {{ $relatedTalks = $relatedTalks | append . }}
{{ end }}
{{ $sortedTalks := sort $relatedTalks ".Date" "desc" }}
{{ $totalPlayed := len $sortedTalks }}

{{/* Count videos */}}
{{ $videoCount := 0 }}
{{ range $sortedTalks }}
  {{ if .Params.youtube }}
    {{ $videoCount = add $videoCount 1 }}
  {{ end }}
{{ end }}

<div class="flex flex-col lg:grid lg:grid-cols-4 gap-4 mt-4 px-4">
  {{/* Left column - Stats */}}
  <div class="hidden lg:flex flex-col items-end gap-4">
    <div class="stats stats-vertical shadow bg-base-200">
      <div class="stat">
        <div class="stat-figure text-primary">
          <ion-icon name="mic" style="font-size: 2rem;"></ion-icon>
        </div>
        <div class="stat-title">Played</div>
        <div class="stat-value text-primary">{{ $totalPlayed }}</div>
        <div class="stat-desc">times</div>
      </div>
      {{ if gt $videoCount 0 }}
      <div class="stat">
        <div class="stat-figure text-error">
          <ion-icon name="logo-youtube" style="font-size: 2rem;"></ion-icon>
        </div>
        <div class="stat-title">Videos</div>
        <div class="stat-value text-error">{{ $videoCount }}</div>
        <div class="stat-desc">recorded</div>
      </div>
      {{ end }}
      <div class="stat">
        <div class="stat-figure text-secondary">
          <ion-icon name="calendar" style="font-size: 2rem;"></ion-icon>
        </div>
        <div class="stat-title">First played</div>
        <div class="stat-value text-secondary text-lg">{{ .Date | time.Format "Jan 2006" }}</div>
      </div>
    </div>
  </div>

  {{/* Main content - spans 2 columns */}}
  <div class="lg:col-span-2 min-w-0">
    <article class="mx-auto prose prose-quoteless dark:prose-invert max-w-none lg:max-w-prose" itemscope itemtype="http://schema.org/Article">
      {{ template "_internal/schema.html" . }}

      <header>
        <h1 itemprop="headline" style="margin-bottom: 0.25rem;">{{ .Title }}</h1>
        <p class="text-base-content/60 mt-2">
          <span class="badge badge-primary badge-lg gap-1">
            <ion-icon name="albums"></ion-icon>
            Talk Template
          </span>
        </p>
      </header>

      {{/* Mobile stats */}}
      <div class="lg:hidden my-4">
        <div class="stats stats-horizontal shadow bg-base-200 w-full">
          <div class="stat place-items-center">
            <div class="stat-title">Played</div>
            <div class="stat-value text-primary text-2xl">{{ $totalPlayed }}</div>
          </div>
          {{ if gt $videoCount 0 }}
          <div class="stat place-items-center">
            <div class="stat-title">Videos</div>
            <div class="stat-value text-error text-2xl">{{ $videoCount }}</div>
          </div>
          {{ end }}
          <div class="stat place-items-center">
            <div class="stat-title">Since</div>
            <div class="stat-value text-secondary text-lg">{{ .Date | time.Format "2006" }}</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <h2>Abstract</h2>
      {{ .Content | emojify }}

      {{/* Links section if any */}}
      {{- with .Params.links -}}
      <div class="divider"></div>
      <h2 id="resources">Resources</h2>
      <p>Useful resources related to this talk.</p>
      <div class="grid grid-cols-2 lg:grid-cols-3 gap-2 my-4">
        {{- range . -}}
        <a href="{{ .url }}" target="_blank" rel="noopener noreferrer" class="card bg-base-200 hover:bg-base-300 transition-colors no-underline">
          <div class="card-body p-2">
            <h3 class="card-title m-0">{{ .title }} <ion-icon name="open-outline" class="text-sm"></ion-icon></h3>
            {{- $desc := or .description .details -}}
            {{- with $desc -}}
            <blockquote class="m-0 py-1 text-sm">{{ . | emojify | markdownify }}</blockquote>
            {{- end -}}
          </div>
        </a>
        {{- end -}}
      </div>
      {{- end -}}

      {{/* Conference list - using partial */}}
      <div class="divider"></div>
      <h2 id="conferences">Conferences</h2>
      <p>This talk was presented at the following conferences:</p>
      
      {{ partial "template-conferences.html" (dict "talks" $sortedTalks) }}

    </article>
  </div>

  {{/* Right sidebar */}}
  <div class="flex flex-col space-y-4 lg:items-start">
    {{/* Quick jump to videos if any */}}
    {{ if gt $videoCount 0 }}
    <div class="w-full">
      <div class="text-sm font-semibold mb-2 flex items-center gap-2">
        <ion-icon name="logo-youtube" class="text-error"></ion-icon>
        Available Videos
      </div>
      <ul class="menu menu-sm bg-base-200 rounded-box w-full">
        {{ range $sortedTalks }}
        {{ if .Params.youtube }}
        <li>
          <a href="{{ .RelPermalink }}#video" class="flex flex-col items-start py-2">
            <span class="text-xs text-base-content/60">{{ .Date | time.Format "2006-01-02" }} â€“ {{ .Params.conference.name }}</span>
            <span class="text-sm">{{ .Title }}</span>
          </a>
        </li>
        {{ end }}
        {{ end }}
      </ul>
    </div>
    {{ end }}
  </div>
</div>
{{ end }}

{{ define "js" }}

{{ if site.Params.customSyntaxHighlighting }}
  {{- $syntaxLightCSS := resources.Get "css/syntax-light.css" | minify -}}
  {{- $syntaxDarkCSS := resources.Get "css/syntax-dark.css" | minify -}}

  <script>
    window.customSyntaxHighlighting = {
      light: {{ $syntaxLightCSS.RelPermalink }},
      dark: {{ $syntaxDarkCSS.RelPermalink }}
    }

    document.addEventListener('alpine:initialized', () => {
      var isDark = Alpine.store('darkMode').isDark()
      var customSyntaxHighlightingUrl = isDark ? window.customSyntaxHighlighting.dark : window.customSyntaxHighlighting.light

      document
        .querySelector('link[data-custom-syntax-highlighting]')
        .setAttribute('href', customSyntaxHighlightingUrl)
    })
  </script>
{{ end }}

{{ end }}

