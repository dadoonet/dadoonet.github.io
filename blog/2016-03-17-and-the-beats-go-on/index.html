<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>And the beats go on! - David Pilato</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=https://david.pilato.fr/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=https://david.pilato.fr/js/eureka.min.e8043b71b627e3cfd9b2a5de56adf007f5af83dee672ca0c186aa2e29a10d6f648632064d0c00b2fa4d1b11e0f196af3.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<link rel=stylesheet href=https://david.pilato.fr/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=https://david.pilato.fr/js/fontawesome.min.6e145f2524b9f9164af19f0f4b7c3da1a8394823ac28f060be0f8cc47cd412b38ce9302e8a98cef940ff716e9d1f901c.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=preconnect href=https://www.google-analytics.com crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=UA-62381049-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-62381049-1")</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/featured.png"><meta name=twitter:title content="And the beats go on!"><meta name=twitter:description content="Sounds like a cool music, right? At least this is one of my favorite tracks.
May be some of you already know that, I enjoy doing some DeeJaying for my friends.
But today, I want to speak about another kind of beats. Elastic beats!
Elastic Beats
Actually my favorite funky music track is a one from Georges Duke: Reach out! But this is another story&mldr;
Beats So what are beats?
Beats are lightweight shippers that collect and ship all kinds of operational data to Elasticsearch"><meta name=description content="Sounds like a cool music, right? At least this is one of my favorite tracks.
May be some of you already know that, I enjoy doing some DeeJaying for my friends.
But today, I want to speak about another kind of beats. Elastic beats!
Elastic Beats
Actually my favorite funky music track is a one from Georges Duke: Reach out! But this is another story&mldr;
Beats So what are beats?
Beats are lightweight shippers that collect and ship all kinds of operational data to Elasticsearch"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://david.pilato.fr/blog/"},{"@type":"ListItem","position":2,"name":"And the beats go on!","item":"https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/"},"headline":"And the beats go on! - David Pilato","image":"https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/featured.png","datePublished":"2016-03-17T17:35:39+01:00","dateModified":"2016-03-17T17:35:39+01:00","wordCount":2165,"author":{"@type":"Person","name":["David Pilato"]},"publisher":{"@type":"Person","name":"David Pilato"},"description":"Sounds like a cool music, right? At least this is one of my favorite tracks.\nMay be some of you already know that, I enjoy doing some DeeJaying for my friends.\nBut today, I want to speak about another kind of beats. Elastic beats!\nElastic Beats\nActually my favorite funky music track is a one from Georges Duke: Reach out! But this is another story\u0026hellip;\nBeats So what are beats?\nBeats are lightweight shippers that collect and ship all kinds of operational data to Elasticsearch"}</script><meta property="og:title" content="And the beats go on! - David Pilato"><meta property="og:type" content="article"><meta property="og:url" content="https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/"><meta property="og:description" content="Sounds like a cool music, right? At least this is one of my favorite tracks.
May be some of you already know that, I enjoy doing some DeeJaying for my friends.
But today, I want to speak about another kind of beats. Elastic beats!
Elastic Beats
Actually my favorite funky music track is a one from Georges Duke: Reach out! But this is another story&mldr;
Beats So what are beats?
Beats are lightweight shippers that collect and ship all kinds of operational data to Elasticsearch"><meta property="og:locale" content="en"><meta property="og:site_name" content="David Pilato"><meta property="article:published_time" content="2016-03-17T17:35:39+01:00"><meta property="article:modified_time" content="2016-03-17T17:35:39+01:00"><meta property="article:section" content="blog"><meta property="article:tag" content="beats"><meta property="article:tag" content="elasticsearch"><meta property="article:tag" content="kibana"><meta property="article:tag" content="go"><meta property="og:see_also" content="https://david.pilato.fr/blog/2016-01-05-understanding-zipfs-law/"><meta property="og:see_also" content="https://david.pilato.fr/blog/2015-12-10-building-a-directory-map-with-elk/"><meta property="og:see_also" content="https://david.pilato.fr/blog/2015-11-17-index-twitter-on-found/"><meta property="og:see_also" content="https://david.pilato.fr/blog/2015-06-01-indexing-twitter-with-logstash-and-elasticsearch/"><meta property="og:see_also" content="https://david.pilato.fr/blog/2015-05-02-devoxx-france-2015/"><meta property="og:see_also" content="https://david.pilato.fr/blog/2015-04-28-exploring-capitaine-train-dataset/"><body class="flex flex-col min-h-screen"><header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm"><div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">David Pilato</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">Home</a>
<a href=/blog/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">Blog</a>
<a href=https://djdadoo.pilato.fr/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">DJ Mixes</a>
<a href=/authors/david-pilato/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">About me</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="flex-grow pt-16"><div class=pl-scrollbar><div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>And the beats go on!</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2016-03-17</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>11 min read</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=https://david.pilato.fr/categories/tutorial/ class=hover:text-eureka>tutorial</a></div></div><img src=https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/featured.png class=w-full alt="Featured Image"><p>Sounds like a cool music, right? At least this is one of my favorite tracks.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/fOaxEa5ONJw style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><p>May be some of you already know that, I enjoy doing <a href=https://itunes.apple.com/fr/podcast/dj-dadoo.net-mixes/id959495351>some DeeJaying</a>
for my friends.</p><p>But today, I want to speak about another kind of beats. Elastic beats!</p><figure><img src=beats.png alt="Elastic Beats"><figcaption><p>Elastic Beats</p></figcaption></figure><p>Actually my favorite funky music track is a one from Georges Duke: Reach out!
But this is another story&mldr;</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/Aw0MpVVNj0g style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h2 id=beats>Beats</h2><p>So what are beats?</p><blockquote><p>Beats are lightweight shippers that collect and ship all kinds of operational data to Elasticsearch</p></blockquote><p>Important terms here:</p><ul><li><code>lightweight</code>: indeed, written in Golang, using few resources</li><li><code>all kinds of operational data</code>: yeah! You are just limited by your imagination 😊. It can come from a <a href=https://www.elastic.co/products/beats/packetbeat>network card</a> from where you can <em>sniff</em> a known protocol such as MySQL, PostgreSQL, MongoDB, ICMP, HTTP&mldr; It can come from a <a href=https://www.elastic.co/products/beats/filebeat>file</a> you can basically <code>tail -f</code> to elasticsearch. It can come from various <a href=https://www.elastic.co/products/beats/topbeat>metrics</a> from your system, like running a TOP command on every single machine you have and correlate information from them&mldr;</li></ul><p>So very flexible&mldr;</p><p>I came with this idea&mldr; I like music. I like beats. Let&rsquo;s try to create another beat: <code>soundbeat</code>!</p><h2 id=prerequisites>Prerequisites</h2><p>You need to have:</p><ul><li><code>go</code>: <code>brew install go</code></li><li><code>glide</code>: <code>brew install glide</code></li></ul><h2 id=soundbeat>Soundbeat</h2><p>The goal is more to learn how to write a beat than the feature itself.
The <code>soundbeat</code> will read a MP3 file, then extract the sound level for left and right channels using a given period for each sample.</p><p>The final goal is to generate a waveform like this:</p><figure><img src=TheWhispers-AndTheBeatGoesOn.png alt="And the beat goes on"><figcaption><p>And the beat goes on</p></figcaption></figure><h3 id=generate-a-beat-from-a-template>Generate a beat from a template</h3><p>We will use the great <a href=https://github.com/elastic/beat-generator>Beat generator project</a> which basically creates a skeleton for your beat.</p><pre><code class=language-sh>cookiecutter https://github.com/elastic/beat-generator.git
</code></pre><p>The generator is asking some questions:</p><pre><code class=language-txt>project_name [Examplebeat]: soundbeat
github_name [your-github-name]: dadoonet
beat [soundbeat]: 
beat_path [github.com/dadoonet]: 
full_name [Firstname Lastname]: David Pilato
</code></pre><p>Just <code>cd</code> in the generated dir:</p><pre><code class=language-sh>cd $GOPATH/src/github.com/dadoonet/soundbeat
</code></pre><p>You have a full beat project:</p><pre><code class=language-sh>$ tree
.
├── CONTRIBUTING.md
├── LICENSE
├── Makefile
├── README.md
├── beater
│   └── soundbeat.go
├── config
│   └── config.go
├── dev-tools
│   └── packer
│       ├── Makefile
│       ├── beats
│       │   └── soundbeat.yml
│       └── version.yml
├── docs
│   └── index.asciidoc
├── etc
│   ├── beat.yml
│   ├── fields.yml
│   └── soundbeat.template.json
├── glide.yaml
├── main.go
├── main_test.go
└── tests
    └── system
        ├── config
        │   └── soundbeat.yml.j2
        ├── requirements.txt
        ├── soundbeat.py
        └── test_base.py
</code></pre><p>This project depends on <a href=https://github.com/elastic/beats/tree/master/libbeat>libbeat</a> which provides already all the needed stuff to read configuration file or write data to stdout or elasticsearch.</p><p>Just run now:</p><pre><code class=language-sh>make
</code></pre><p>It will install the needed dependencies and create your git repository and <code>git add</code> all your files.</p><p>If you run <code>make</code> again, it will compile and build your binary <code>soundbeat</code>.</p><h3 id=libsox-sound-library>libsox sound library</h3><p>The <a href=http://sox.sourceforge.net/>SoX library</a> provides all the tool we need for our use case.
You have different ways for installing the library. On my mac, I used:</p><pre><code class=language-sh>brew install sox
</code></pre><p>Kristoffer Grönlund created a <a href=https://github.com/krig/go-sox>golang binding for SoX</a>. Let&rsquo;s use it.</p><p>In <code>glide.yaml</code>, we add this dependency:</p><pre><code class=language-yaml>- package: github.com/krig/go-sox
</code></pre><p>Then pull the library from internet with:</p><pre><code class=language-sh>make update-deps
</code></pre><p>We now have the library. We can start coding our beat.</p><h3 id=writing-the-logic>Writing the logic</h3><p>All the code will basically go into <code>beater/soundbeat.go</code>.</p><h4 id=import-libs>Import libs</h4><p>We have to import all the needed libs:</p><pre><code class=language-go>import (
 &quot;fmt&quot;
 &quot;time&quot;
 &quot;errors&quot;
 &quot;math&quot;

 &quot;github.com/krig/go-sox&quot;

 &quot;github.com/elastic/beats/libbeat/beat&quot;
 &quot;github.com/elastic/beats/libbeat/cfgfile&quot;
 &quot;github.com/elastic/beats/libbeat/common&quot;
 &quot;github.com/elastic/beats/libbeat/logp&quot;

 &quot;github.com/dadoonet/soundbeat/config&quot;
)
</code></pre><h4 id=soundbeat-settings>Soundbeat settings</h4><p>We will define 3 settings:</p><ul><li><code>name</code>: MP3 filename</li><li><code>period</code>: size of one sound sample (like <code>100ms</code>)</li><li><code>zoom</code>: it&rsquo;s basically a hack for a better rendering in Kibana as it <a href=https://github.com/elastic/kibana/issues/6559>does not support aggregations under 1 second</a>.</li></ul><pre><code class=language-go>type Soundbeat struct {
 beatConfig *config.Config
 done       chan struct{}

 name       string
 period     time.Duration
 zoom       float64
}
</code></pre><p>Settings are read from <code>soundbeat.yml</code> file by default. This file is automatically generated from the default <a href=https://github.com/elastic/beats/blob/master/libbeat/etc/libbeat.yml>libbeat configuration file</a> and the content of <code>etc/beat.yml</code>.</p><p>We can change this file and provide a default example:</p><pre><code class=language-yaml>################### Soundbeat Configuration Example #########################

############################# Soundbeat ######################################

soundbeat:
  # MP3 file to analyze
  name: musics/TheWhispers-AndTheBeatGoesOn.mp3
  # Defines the size of each sample
  period: 100ms
  # Zoom factor for a better Kibana rendering (default to 1.0)
  zoom: 10.0
</code></pre><p>The <code>config/config.go</code> file managed this configuration file:</p><pre><code class=language-go>// Config is put into a different package to prevent cyclic imports in case
// it is needed in several locations

package config

type Config struct {
 Soundbeat SoundbeatConfig
}

type SoundbeatConfig struct {
 Name string `yaml:&quot;name&quot;`
 Period string `yaml:&quot;period&quot;`
 Zoom float64 `yaml:&quot;zoom&quot;`
}
</code></pre><p>We need to change the code in <code>Setup</code> method:</p><pre><code class=language-go>func (bt *Soundbeat) Setup(b *beat.Beat) error {
  // All libSoX applications must start by initializing the SoX library
 if !sox.Init() {
  return errors.New(&quot;Failed to initialize SoX&quot;)
 }
  // Make sure to call Quit before terminating
  defer sox.Quit()

  period, err := configDuration(bt.beatConfig.Soundbeat.Period, 10 * time.Millisecond)
  if err != nil {
    return err
  }

 name := bt.beatConfig.Soundbeat.Name
 if name == &quot;&quot; {
  return errors.New(&quot;no name set&quot;)
 }

  zoom := 1.0
  if bt.beatConfig.Soundbeat.Zoom != 0.0 {
    zoom = bt.beatConfig.Soundbeat.Zoom
  }

  bt.name = name
  bt.period = period
  bt.zoom = zoom

  return nil
}

func configDuration(cfg string, d time.Duration) (time.Duration, error) {
  if cfg != &quot;&quot; {
    return time.ParseDuration(cfg)
  } else {
    return d, nil
  }
}
</code></pre><p>In this method, we make sure that <code>libSoX</code> is working well. We also define all default values and check that a name has been set.</p><h3 id=the-run-method>The Run method</h3><p>The <code>Run</code> method is where we need to implement the logic. It will read the file, extract the samples and for each sample will generate an event which should be sent to elasticsearch.</p><p>This opens the file for reading:</p><pre><code class=language-go>in := sox.OpenRead(bt.name)
if in == nil {
  logp.Err(&quot;Failed to open input file&quot;)
}
// Close the file before exiting
defer in.Release()
</code></pre><p>The total duration is the number of samples given by <code>Length()</code> divided by 2 (as we expect a stereo file) divided by the rate give by <code>Rate()</code>.</p><p>For example, for the MP3 file of <code>The Whispers</code>, we have <code>26 123 340</code> samples, the file is a stereo file (2 tracks) and the bitrate is <code>44 100 Hz</code>.
So the duration of the track is: <code>26123340/2/44100</code> which is <code>296.182s</code></p><pre><code class=language-go>duration := float64(in.Signal().Length()) / float64(in.Signal().Channels()) / in.Signal().Rate()
</code></pre><p>We will use the <code>@timestamp</code> defacto standard for the timestamp field in Logstash/Beats/Kibana applications.
So we will start from <code>now()</code> and add a new sample every <code>period</code>.</p><p>We also apply the zoom factor to the time scale.</p><pre><code class=language-go>modifed_period := float64(period.Nanoseconds()) * bt.zoom
now = now.Add(time.Duration(modifed_period))
</code></pre><p>For each sample, we get the level of the sound for left and right channels and we store them in <code>left</code> and <code>right</code> fields.</p><p>Then we generate an event which contains this information and we publish it:</p><pre><code class=language-go>event := common.MapStr{
  &quot;@timestamp&quot;:   common.Time(now),
  &quot;type&quot;:         b.Name,
  &quot;left&quot;:         left * 100.0,
  &quot;right&quot;:        right * 100.0,
}

b.Events.PublishEvent(event)
</code></pre><p>This is how the full <code>Run</code> method looks like:</p><pre><code class=language-go>func (bt *Soundbeat) Run(b *beat.Beat) error {
  logp.Info(&quot;soundbeat is starting...&quot;)

  // Open the input file (with default parameters)
  in := sox.OpenRead(bt.name)
  if in == nil {
    logp.Err(&quot;Failed to open input file&quot;)
  }
  // Close the file before exiting
  defer in.Release()

  // This example program requires that the audio has precisely 2 channels:
  if in.Signal().Channels() != 2 {
    logp.Err(&quot;Input must be 2 channels&quot;)
  }

  duration := float64(in.Signal().Length()) / float64(in.Signal().Channels()) / in.Signal().Rate()

  now := time.Now()

  period := bt.period

  // Convert block size (in seconds) to a number of samples:
  block_size := int64(period.Seconds() * float64(in.Signal().Rate()) * float64(in.Signal().Channels()) + 0.5)
  // Make sure that this is at a `wide sample' boundary:
  block_size -= block_size % int64(in.Signal().Channels())
  // Allocate a block of memory to store the block of audio samples:
  buf := make([]sox.Sample, block_size)

  // Read and process blocks of audio for the selected duration or until EOF:
  for blocks := 0; in.Read(buf, uint(block_size)) == block_size &amp;&amp; float64(blocks) * period.Seconds() &lt; duration; blocks++ {
    left := 0.0
    right := 0.0

    // We increment time with a block_size (in seconds)
    // But we first zoom accordingly to the zoom factor we set
    modifed_period := float64(period.Nanoseconds()) * bt.zoom
    now = now.Add(time.Duration(modifed_period))

    for i := int64(0); i &lt; block_size; i++ {
      // convert the sample from SoX's internal format to a `float64' for
      // processing in this application:
      sample := sox.SampleToFloat64(buf[i])

      // The samples for each channel are interleaved; in this example
      // we allow only stereo audio, so the left channel audio can be found in
      // even-numbered samples, and the right channel audio in odd-numbered
      // samples:
      if (i &amp; 1) != 0 {
        right = math.Max(right, math.Abs(sample))
      } else {
        left = math.Max(left, math.Abs(sample))
      }
    }

    event := common.MapStr{
      &quot;@timestamp&quot;:   common.Time(now),
      &quot;type&quot;:         b.Name,
      &quot;left&quot;:         left * 100.0,
      &quot;right&quot;:        right * 100.0,
    }

    b.Events.PublishEvent(event)
  }

  logp.Info(&quot;soundbeat ended analyzing file %s&quot;, bt.name)
  return nil
}
</code></pre><p>We can now build our beat:</p><pre><code class=language-sh># This will merge our changes in etc/beat.yml to ./soundbeat.yml
make update
# This will compile
make
</code></pre><p>And use it! This will start our beat in debug mode without pushing anything:</p><pre><code class=language-sh>./soundbeat -N -e -d &quot;*&quot;
</code></pre><p>It will produce something like:</p><pre><code class=language-txt>2016/03/18 12:40:18.031084 beat.go:221: DBG  Initializing output plugins
2016/03/18 12:40:18.031128 publish.go:205: INFO Dry run mode. All output types except the file based one are disabled.
2016/03/18 12:40:18.031144 geolite.go:24: INFO GeoIP disabled: No paths were set under shipper.geoip.paths
2016/03/18 12:40:18.031186 publish.go:291: INFO Publisher name: MacBook-Pro-4.local
2016/03/18 12:40:18.031320 beat.go:238: INFO Init Beat: soundbeat; Version: 5.0.0-SNAPSHOT
2016/03/18 12:40:18.031670 soundbeat.go:76: INFO soundbeat has been configured:
2016/03/18 12:40:18.031681 soundbeat.go:77: INFO  - Name: musics/TheWhispers-AndTheBeatGoesOn.mp3
2016/03/18 12:40:18.031687 soundbeat.go:78: INFO  - Period: 100ms
2016/03/18 12:40:18.031703 soundbeat.go:79: INFO  - Zoom: 10.000000
2016/03/18 12:40:18.031769 beat.go:267: INFO soundbeat sucessfully setup. Start running.
2016/03/18 12:40:18.031774 soundbeat.go:93: INFO soundbeat is starting...
2016/03/18 12:40:18.032152 soundbeat.go:116: INFO  - Duration 296.182993 s
2016/03/18 12:40:18.032165 soundbeat.go:117: INFO  - Channels 2
2016/03/18 12:40:18.032171 soundbeat.go:118: INFO  - Rate 44100 Hz
2016/03/18 12:40:18.032721 publish.go:112: DBG  Publish: {
  &quot;@timestamp&quot;: &quot;2016-03-18T12:40:19.032Z&quot;,
  &quot;beat&quot;: {
    &quot;hostname&quot;: &quot;MacBook-Pro-4.local&quot;,
    &quot;name&quot;: &quot;MacBook-Pro-4.local&quot;
  },
  &quot;left&quot;: 0,
  &quot;right&quot;: 0,
  &quot;type&quot;: &quot;soundbeat&quot;
}
...
2016/03/18 12:38:52.469365 async.go:48: DBG  publisher disabled
2016/03/18 12:38:52.469688 publish.go:112: DBG  Publish: {
  &quot;@timestamp&quot;: &quot;2016-03-18T13:28:10.947Z&quot;,
  &quot;beat&quot;: {
    &quot;hostname&quot;: &quot;MacBook-Pro-4.local&quot;,
    &quot;name&quot;: &quot;MacBook-Pro-4.local&quot;
  },
  &quot;left&quot;: 0,
  &quot;right&quot;: 0,
  &quot;type&quot;: &quot;soundbeat&quot;
}
2016/03/18 12:38:52.469695 async.go:48: DBG  publisher disabled
2016/03/18 12:38:52.469768 soundbeat.go:167: INFO soundbeat ended analyzing file musics/TheWhispers-AndTheBeatGoesOn.mp3
2016/03/18 12:38:52.469911 beat.go:307: INFO Start exiting beat
2016/03/18 12:38:52.469926 beat.go:282: INFO Stopping Beat
2016/03/18 12:38:52.469937 beat.go:290: INFO Cleaning up soundbeat before shutting down.
2016/03/18 12:38:52.469945 beat.go:139: INFO Exit beat completed
</code></pre><h2 id=connecting-to-elasticsearch>Connecting to elasticsearch</h2><p>We need to define a template for elasticsearch if we want to force elasticsearch using our mapping.
But we are lucky! The beat-generator provides everything out of the box!</p><p>Just edit <code>etc/fields.yml</code> and change the <code>soundbeat</code> part to:</p><pre><code class=language-yaml>soundbeat:
  type: group
  fields:
    - name: name
      type: string
      required: true
      description: &gt;
        Sound file name
    - name: left
      type: double
      required: true
      description: &gt;
        Left sound level
    - name: right
      type: double
      required: true
      description: &gt;
        Right sound level
</code></pre><p>Then, run:</p><pre><code class=language-sh>make update
</code></pre><p>It will generate the <code>etc/soundbeat.template.json</code> file. And cherry on the cake, it will also update the documentation in <code>docs</code> dir.</p><p>Start elasticsearch:</p><pre><code class=language-sh>bin/elasticsearch
[2016-03-18 14:53:33,487][INFO ][node                     ] [Katu] version[2.2.1], pid[82105], build[d045fc2/2016-03-09T09:38:54Z]
[2016-03-18 14:53:33,489][INFO ][node                     ] [Katu] initializing ...
[2016-03-18 14:53:34,111][INFO ][plugins                  ] [Katu] modules [lang-expression, lang-groovy], plugins [], sites []
[2016-03-18 14:53:34,285][INFO ][env                      ] [Katu] using [1] data paths, mounts [[/ (/dev/disk1)]], net usable_space [3.6gb], net total_space [464.7gb], spins? [unknown], types [hfs]
[2016-03-18 14:53:34,285][INFO ][env                      ] [Katu] heap size [990.7mb], compressed ordinary object pointers [true]
[2016-03-18 14:53:34,286][WARN ][env                      ] [Katu] max file descriptors [10240] for elasticsearch process likely too low, consider increasing to at least [65536]
[2016-03-18 14:53:36,456][INFO ][node                     ] [Katu] initialized
[2016-03-18 14:53:36,456][INFO ][node                     ] [Katu] starting ...
[2016-03-18 14:53:36,572][INFO ][transport                ] [Katu] publish_address {127.0.0.1:9300}, bound_addresses {[fe80::1]:9300}, {[::1]:9300}, {127.0.0.1:9300}
[2016-03-18 14:53:36,584][INFO ][discovery                ] [Katu] elasticsearch/b_T6HUb-TXyUTN8Af6YdEQ
[2016-03-18 14:53:39,618][INFO ][cluster.service          ] [Katu] new_master {Katu}{b_T6HUb-TXyUTN8Af6YdEQ}{127.0.0.1}{127.0.0.1:9300}, reason: zen-disco-join(elected_as_master, [0] joins received)
[2016-03-18 14:53:39,638][INFO ][http                     ] [Katu] publish_address {127.0.0.1:9200}, bound_addresses {[fe80::1]:9200}, {[::1]:9200}, {127.0.0.1:9200}
[2016-03-18 14:53:39,638][INFO ][node                     ] [Katu] started
</code></pre><p>And apply the template:</p><pre><code class=language-sh>curl -XPUT 'http://localhost:9200/_template/soundbeat' -d@etc/soundbeat.template.json
</code></pre><p>And launch <code>soundbeat</code> again with the standard mode:</p><pre><code class=language-sh>./soundbeat
</code></pre><p>In elasticsearch logs, you should see:</p><pre><code class=language-sh>[2016-03-18 14:54:31,599][INFO ][cluster.metadata         ] [Katu] [soundbeat-2016.03.18] creating index, cause [auto(bulk api)], templates [soundbeat], shards [5]/[1], mappings [_default_, soundbeat]
[2016-03-18 14:54:31,725][INFO ][cluster.metadata         ] [Katu] [soundbeat-2016.03.18] update_mapping [soundbeat]
[2016-03-18 14:54:31,744][INFO ][cluster.routing.allocation] [Katu] Cluster health status changed from [RED] to [YELLOW] (reason: [shards started [[soundbeat-2016.03.18][4], [soundbeat-2016.03.18][4]] ...]).
</code></pre><h2 id=visualize-in-kibana>Visualize in Kibana</h2><p>Just launch Kibana:</p><pre><code class=language-sh>bin/kibana
</code></pre><p>And open <a href=http://0.0.0.0:5601/>http://0.0.0.0:5601/</a></p><p>You have to change the time range. And look into the future!</p><p>Why this? Because we injected data from now and generated a 5 minutes long music waveform.
But remember that we used a <code>zoom</code> factor of <code>10x</code> for a better rendering in Kibana.</p><p>So here, I&rsquo;ll look at data from <code>2016-03-18 14:54:30</code> to <code>2016-03-18 15:03:30</code> for the begining of the music.</p><figure><img src=kibana1.png alt="Select time range"><figcaption><p>Select time range</p></figcaption></figure><p>Let&rsquo;s create a Timeseries visualization!</p><figure><img src=kibana2.png alt="Timeseries visualization"><figcaption><p>Timeseries visualization</p></figcaption></figure><p>Then, we define interval to <code>1s</code> and set the Timelion expression:</p><pre><code class=language-js>.es(index=&quot;soundbeat-*&quot;,metric=&quot;min:left&quot;).bars(1)
</code></pre><figure><img src=kibana3.png alt="Left waveform"><figcaption><p>Left waveform</p></figcaption></figure><p>We can also add the right channel:</p><pre><code class=language-js>.es(index=&quot;soundbeat-*&quot;,metric=&quot;min:left&quot;).bars(1),.es(index=&quot;soundbeat-*&quot;,metric=&quot;min:right&quot;).bars(1)
</code></pre><figure><img src=kibana4.png alt="With Right waveform"><figcaption><p>With Right waveform</p></figcaption></figure><p>But this will overlap. So let&rsquo;s fix that by negative by <code>1</code> the left channel:</p><pre><code class=language-js>.es(index=&quot;soundbeat-*&quot;,metric=&quot;min:left&quot;).multiply(-1).bars(1),.es(index=&quot;soundbeat-*&quot;,metric=&quot;min:right&quot;).bars(1)
</code></pre><p>We now have something which looks like the waveform we are looking for!</p><figure><img src=kibana5.png alt="Final waveform"><figcaption><p>Final waveform</p></figcaption></figure><h2 id=resources>Resources</h2><ul><li><a href=https://www.elastic.co/guide/en/beats/libbeat/current/index.html>Beats Platform Reference</a></li><li><a href=https://github.com/elastic/beat-generator>Beat Generator</a></li><li><a href=https://www.elastic.co/guide/en/beats/libbeat/current/new-beat.html>Beat developer guide</a></li><li><a href=https://github.com/dadoonet/soundbeat>soundbeat source code</a></li></ul></article><div class=my-4><a href=https://david.pilato.fr/tags/beats/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#beats</a>
<a href=https://david.pilato.fr/tags/elasticsearch/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#elasticsearch</a>
<a href=https://david.pilato.fr/tags/kibana/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#kibana</a>
<a href=https://david.pilato.fr/tags/go/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#go</a></div><div class="flex md:justify-end my-4"><style>#share-buttons{display:inline-block;vertical-align:middle}#share-buttons:after{content:"";display:block;clear:both}#share-buttons>div{position:relative;text-align:left;height:36px;width:32px;float:left;text-align:center}#share-buttons>div>svg{height:16px;fill:#000;margin-top:10px}#share-buttons>div:hover{cursor:pointer}#share-buttons>div.facebook:hover>svg{fill:#3b5998}#share-buttons>div.twitter:hover>svg{fill:#55acee}#share-buttons>div.linkedin:hover>svg{fill:#0077b5}#share-buttons>div.pinterest:hover>svg{fill:#cb2027}#share-buttons>div.mail:hover>svg{fill:#7d7d7d}#share-buttons>div.facebook>svg{height:18px;margin-top:9px}#share-buttons>div.twitter>svg{height:20px;margin-top:8px}#share-buttons>div.linkedin>svg{height:19px;margin-top:7px}#share-buttons>div.pinterest>svg{height:20px;margin-top:9px}#share-buttons>div.mail>svg{height:14px;margin-top:11px}</style><div id=share-buttons><div class=facebook title="Share this on Facebook" onclick='window.open("http://www.facebook.com/share.php?u=https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759H734V905H479V609h255V391q0-186 104-288.5T1115 0q147 0 228 12z"/></svg></div><div class=twitter title="Share this on Twitter" onclick='window.open("http://twitter.com/intent/tweet?via=dadoonet&text=🧑🏼‍💻 Blog: And the beats go on! 👉🏼&url=https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div><div class=linkedin title="Share this on Linkedin" onclick='window.open("https://www.linkedin.com/shareArticle?mini=true&url=https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/&title=&summary=&source=")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991H147V625h330zm21-306q1 73-50.5 122T312 490h-2q-82 0-132-49t-50-122q0-74 51.5-122.5T314 148t133 48.5T498 319zm1166 729v568h-329v-530q0-105-40.5-164.5T1168 862q-63 0-105.5 34.5T999 982q-11 30-11 81v553H659q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5T1285 602q171 0 275 113.5t104 332.5z"/></svg></div><div class=mail title="Share this through Email" onclick='window.open("mailto:?&body=https://david.pilato.fr/blog/2016-03-17-and-the-beats-go-on/")'><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47H160q-66 0-113-47T0 1504V710q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 1e2-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38T639 1015q-91-64-262-182.5T172 690q-62-42-117-115.5T0 438q0-78 41.5-130T160 256h1472q65 0 112.5 47t47.5 113z"/></svg></div></div><a href=https://github.com/dadoonet/dadoonet.github.io/tree/main/content/blog/2016-03-17-and-the-beats-go-on/index.md title="Edit this page"><i class="fas fa-edit mr-1"></i></a></div><div class=py-2><div class="my-8 flex flex-col items-center md:flex-row"><a href=https://david.pilato.fr/authors/david-pilato/ class="md:me-4 text-primary-text h-24 w-24"><img src=https://david.pilato.fr/authors/david-pilato/david_pilato.png class="bg-primary-bg w-full rounded-full" alt=Avatar></a><div class="mt-4 w-full md:mt-0 md:w-auto"><a href=https://david.pilato.fr/authors/david-pilato/ class="mb-2 block border-b pb-1 text-lg font-bold"><h3>David Pilato</h3></a><span class="block pb-2">20+ years of experience, mostly in Java. Living in Cergy, France.</span>
<a href=mailto:david+blog@pilato.fr class=me-2><i class="fas fa-envelope"></i></a>
<a href=https://twitter.com/dadoonet class=me-2><i class="fab fa-twitter"></i></a>
<a href=https://github.com/dadoonet class=me-2><i class="fab fa-github"></i></a>
<a href=https://www.linkedin.com/in/dadoonet/ class=me-2><i class="fab fa-linkedin"></i></a></div></div></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div><span class="text-primary-text block font-bold">Previous</span>
<a href=https://david.pilato.fr/blog/2016-07-27-creating-a-plugin-for-elasticsearch-5-dot-0-using-maven/ class=block>Creating a plugin for elasticsearch 5.0 using Maven</a></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">Next</span>
<a href=https://david.pilato.fr/blog/2016-01-12-3-years-time-flies/ class=block>3 years! Time flies!</a></div></div><script id=utterances src=https://utteranc.es/client.js issue-term=pathname label=💬 comments repo=dadoonet/dadoonet.github.io theme=preferred-color-scheme crossorigin=anonymous async></script><script>storageColorScheme=="Light"?document.getElementById("utterances").setAttribute("theme","github-light"):storageColorScheme=="Dark"&&document.getElementById("utterances").setAttribute("theme","github-dark")</script></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>On This Page</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#beats>Beats</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#soundbeat>Soundbeat</a><ul><li><a href=#generate-a-beat-from-a-template>Generate a beat from a template</a></li><li><a href=#libsox-sound-library>libsox sound library</a></li><li><a href=#writing-the-logic>Writing the logic</a><ul><li><a href=#import-libs>Import libs</a></li><li><a href=#soundbeat-settings>Soundbeat settings</a></li></ul></li><li><a href=#the-run-method>The Run method</a></li></ul></li><li><a href=#connecting-to-elasticsearch>Connecting to elasticsearch</a></li><li><a href=#visualize-in-kibana>Visualize in Kibana</a></li><li><a href=#resources>Resources</a></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>See Also</h3><a href=https://david.pilato.fr/blog/2016-01-05-understanding-zipfs-law/ class=no-underline>Understanding Zipf's law</a><br><a href=https://david.pilato.fr/blog/2015-12-10-building-a-directory-map-with-elk/ class=no-underline>Building a directory map with ELK</a><br><a href=https://david.pilato.fr/blog/2015-11-17-index-twitter-on-found/ class=no-underline>Index Twitter on found</a><br><a href=https://david.pilato.fr/blog/2015-06-01-indexing-twitter-with-logstash-and-elasticsearch/ class=no-underline>Indexing Twitter with Logstash and Elasticsearch</a><br><a href=https://david.pilato.fr/blog/2015-05-02-devoxx-france-2015/ class=no-underline>Devoxx France 2015</a><br><a href=https://david.pilato.fr/blog/2015-04-28-exploring-capitaine-train-dataset/ class=no-underline>Exploring Capitaine Train dataset</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2022, David Pilato, France
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div><div class="text-center p-1 pin-b"><p class="text-sm text-tertiary-text">Generated from 🇫🇷 with ❤️ on Mon Jan 9, 2023 at 15:14:13 UTC</p></div></div></footer></body></html>