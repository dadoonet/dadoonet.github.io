<!doctype html><html lang=en><meta charset=utf-8>
<meta name=viewport content="width=device-width">
<title>Enriching your postal addresses with Elastic stack - part 1 | David Pilato</title>
<meta name=generator content="Hugo Eureka 0.8.4">
<link rel=stylesheet href=https://david.pilato.fr/css/eureka.min.css>
<script defer src=https://david.pilato.fr/js/eureka.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'">
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script>
<meta name=description content="This blog post is part of a series of 3:
 Importing Bano dataset with Logstash Using Logstash to lookup for addresses in Bano index Using Logstash to enrich an existing dataset with Bano  I&rsquo;m not really sure why, but I love the postal address use case. Often in my career I had to deal with that information. Very often the information is not well formatted so it&rsquo;s hard to find the information you need when you have as an input a not so nice dataset.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://david.pilato.fr/blog/"},{"@type":"ListItem","position":2,"name":"Enriching your postal addresses with Elastic stack - part 1","item":"https://david.pilato.fr/blog/2018-03-22-enriching-your-postal-addresses-with-elastic-stack-part-1/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://david.pilato.fr/blog/2018-03-22-enriching-your-postal-addresses-with-elastic-stack-part-1/"},"headline":"Enriching your postal addresses with Elastic stack - part 1 | David Pilato","datePublished":"2018-03-22T15:31:49+01:00","dateModified":"2018-03-22T15:31:49+01:00","wordCount":2025,"author":{"@type":"Person","name":["David Pilato"]},"publisher":{"@type":"Person","name":"David Pilato"},"description":"This blog post is part of a series of 3:\n Importing Bano dataset with Logstash Using Logstash to lookup for addresses in Bano index Using Logstash to enrich an existing dataset with Bano  I\u0026rsquo;m not really sure why, but I love the postal address use case. Often in my career I had to deal with that information. Very often the information is not well formatted so it\u0026rsquo;s hard to find the information you need when you have as an input a not so nice dataset."}</script><meta property="og:title" content="Enriching your postal addresses with Elastic stack - part 1 | David Pilato">
<meta property="og:type" content="article">
<meta property="og:url" content="https://david.pilato.fr/blog/2018-03-22-enriching-your-postal-addresses-with-elastic-stack-part-1/">
<meta property="og:description" content="This blog post is part of a series of 3:
 Importing Bano dataset with Logstash Using Logstash to lookup for addresses in Bano index Using Logstash to enrich an existing dataset with Bano  I&rsquo;m not really sure why, but I love the postal address use case. Often in my career I had to deal with that information. Very often the information is not well formatted so it&rsquo;s hard to find the information you need when you have as an input a not so nice dataset.">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="David Pilato">
<meta property="article:published_time" content="2018-03-22T15:31:49+01:00">
<meta property="article:modified_time" content="2018-03-22T15:31:49+01:00">
<meta property="article:section" content="blog">
<meta property="article:tag" content="logstash">
<meta property="article:tag" content="elasticsearch">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2018-03-24-enriching-your-postal-addresses-with-elastic-stack-part-3/">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2018-03-23-enriching-your-postal-addresses-with-elastic-stack-part-2/">
<body class="flex flex-col min-h-screen">
<header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
<div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
<a href=/ class="mr-6 text-primary-text text-xl font-bold">David Pilato</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i>
</button>
<div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
<div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
<a href=/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Home</a>
<a href=/blog/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Blog</a>
<a href=https://djdadoo.pilato.fr/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">DJ Mixes</a>
<a href=/authors/david-pilato/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">About me</a>
</div>
<div class=flex>
<div class="relative pt-4 md:pt-0">
<div class="cursor-pointer hover:text-eureka" id=lightDarkMode>
<i class="fas fa-adjust"></i>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open>
</div>
<div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions>
<span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span>
</div>
</div>
</div>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile>
</div>
</nav>
<script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script>
</div>
</header>
<main class="flex-grow pt-16">
<div class=pl-scrollbar>
<div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">
<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
<div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
<h1 class="font-bold text-3xl text-primary-text">Enriching your postal addresses with Elastic stack - part 1</h1>
<div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
<div class="mr-6 my-2">
<i class="fas fa-calendar mr-1"></i>
<span>2018-03-22</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-clock mr-1"></i>
<span>10 min read</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-folder mr-1"></i>
<a href=https://david.pilato.fr/categories/tutorial/ class=hover:text-eureka>tutorial</a>
</div>
<div class="mr-6 my-2">
<i class="fas fa-th-list mr-1"></i>
<a href=https://david.pilato.fr/series/bano/ class=hover:text-eureka>bano</a>
</div>
</div>
<div class=content>
<p>This blog post is part of a series of 3:</p>
<ul>
<li><a href=https://david.pilato.fr/blog/2018-03-22-enriching-your-postal-addresses-with-elastic-stack-part-1/>Importing Bano dataset with Logstash</a></li>
<li><a href=https://david.pilato.fr/blog/2018-03-23-enriching-your-postal-addresses-with-elastic-stack-part-2/>Using Logstash to lookup for addresses in Bano index</a></li>
<li><a href=https://david.pilato.fr/blog/2018-03-24-enriching-your-postal-addresses-with-elastic-stack-part-3/>Using Logstash to enrich an existing dataset with Bano</a></li>
</ul>
<p>I&rsquo;m not really sure why, but I love the postal address use case.
Often in my career I had to deal with that information.
Very often the information is not well formatted so it&rsquo;s hard to find the information you need when you have as an input a not so nice dataset.</p>
<p>Let&rsquo;s take a simple use case. I have a user in my database like:</p>
<pre><code class=language-json>{
  &quot;name&quot;: &quot;Joe Smith&quot;,
  &quot;address&quot;: {
    &quot;number&quot;: &quot;23&quot;,
    &quot;street_name&quot;: &quot;r verdiere&quot;,
    &quot;city&quot;: &quot;rochelle&quot;,
    &quot;country&quot;: &quot;France&quot;
  }
}
</code></pre>
<p>If you live in France you might notice that this address is fairly incomplete.
If we want to send a letter to <code>Joe</code>, it&rsquo;s going to be hard.</p>
<p>Also, I&rsquo;d really like to display on a map, where my customers are located in France.</p>
<p>On the other way around, let&rsquo;s say I&rsquo;m collecting data from a mobile application where I&rsquo;m meeting friends and I&rsquo;d like to remember automatically what was the address of the location last time we met. Basically I have data like:</p>
<pre><code class=language-json>{
  &quot;name&quot;: &quot;Joe Smith&quot;,
  &quot;location&quot;: {
    &quot;lat&quot;: 46.15735,
    &quot;lon&quot;: -1.1551
  }
}
</code></pre>
<p>And I would like to get back the postal address matching this location.</p>
<p>What can we do for that?</p>
<p>We need something to enrich the existing data by fixing the address and providing actual coordinates or the other way back.</p>
<h2 id=bano>Bano</h2>
<p>We can use something like the <a href=https://developers.google.com/maps/>Google Map API</a> for that and do an external call anytime we need, but I see 2 major pain points here:</p>
<ul>
<li>We need to communicate with an external service and may be your company policy does not allow sending to an internet service some private data like your customers data.</li>
<li>You might suffer from some latency anytime you want to call that external service on which you can&rsquo;t really have any knob to make it faster. Speed light is speed light and crossing the ocean may be will always include some latency.</li>
</ul>
<p>We need something local then. In France, we are super lucky because we have a public dataset named <a href=http://openstreetmap.fr/bano>BANO</a> as <code>Base d'Adresses NatiOnale</code> (National Address Database) provided under the <a href=http://openstreetmap.fr>Open Street Map</a> umbrella.</p>
<p>This project exports everyday <a href=http://bano.openstreetmap.fr/data/>the list of known addresses</a> anywhere in France. Here is an extraction of what you can have:</p>
<pre><code class=language-sh>-rw-r--r--@ 1 dpilato  staff   11183891 27 nov 02:03 bano-88.csv
-rw-r--r--@ 1 dpilato  staff   25014545 27 nov 02:04 bano-85.csv
-rw-r--r--@ 1 dpilato  staff    3888078 27 nov 02:04 bano-971.csv
-rw-r--r--@ 1 dpilato  staff   12107391 27 nov 02:04 bano-92.csv
-rw-r--r--@ 1 dpilato  staff    3443396 27 nov 02:04 bano-972.csv
-rw-r--r--@ 1 dpilato  staff    1218424 27 nov 02:05 bano-973.csv
-rw-r--r--@ 1 dpilato  staff     455986 27 nov 02:05 bano-976.csv
-rw-r--r--@ 1 dpilato  staff   21634994 27 nov 02:05 bano-91.csv
-rw-r--r--@ 1 dpilato  staff   15848802 27 nov 02:05 bano-93.csv
-rw-r--r--@ 1 dpilato  staff   14779208 27 nov 02:05 bano-94.csv
-rw-r--r--@ 1 dpilato  staff   17515805 27 nov 02:06 bano-95.csv
-rw-r--r--@ 1 dpilato  staff   17713007 27 nov 02:07 bano-974.csv
-rw-r--r--@ 1 dpilato  staff   71133336 27 nov 02:08 bano-59.csv
</code></pre>
<p>Each CSV file correspond to a subdivision of France that we call a department. It&rsquo;s like a region but smaller. Bigger than a city though.</p>
<h3 id=download-bano-csv-files>Download Bano CSV files</h3>
<p>I wrote a simple shell script to download locally all the files I needed but you can directly consume from Logstash one CSV file with an http_poller plugin.</p>
<pre><code class=language-sh>#!/bin/bash
set -e

download () {
  wget http://bano.openstreetmap.fr/data/$1 --timestamping --directory-prefix=bano-data -c --no-verbose --show-progress
}

DEPTS=95
for i in {01..19} $(seq 21 $DEPTS) {971..974} {976..976} ; do 
  DEPT=$(printf %02d $i)
  echo Downloading bano department $DEPT
  download bano-$DEPT.csv
done
</code></pre>
<blockquote>
<p>What is happening with numbers here?</p>
</blockquote>
<p>Well, France is a moving country. Sometimes departments are merged all together which probably explains why we don&rsquo;t have anymore a department <code>20</code>.
Some department of France are also located far far away from the french metropolitan area. Those are labelled as <code>97x</code>.</p>
<p>Nothing can be simple in France 😅.</p>
<h3 id=loading-elasticsearch>Loading elasticsearch</h3>
<p>Let&rsquo;s now parse the data and load that in elasticsearch, so we will be able to search for addresses.</p>
<p>If we look at one of the CSV file, we can see:</p>
<pre><code class=language-txt>976030950H-26,26,RUE DISMA,97660,Bandrélé,CAD,-12.891701,45.202652
976030950H-28,28,RUE DISMA,97660,Bandrélé,CAD,-12.891900,45.202700
976030950H-30,30,RUE DISMA,97660,Bandrélé,CAD,-12.891781,45.202535
976030950H-32,32,RUE DISMA,97660,Bandrélé,CAD,-12.892005,45.202564
976030950H-3,3,RUE DISMA,97660,Bandrélé,CAD,-12.892444,45.202135
976030950H-34,34,RUE DISMA,97660,Bandrélé,CAD,-12.892068,45.202450
976030950H-4,4,RUE DISMA,97660,Bandrélé,CAD,-12.892446,45.202367
976030950H-5,5,RUE DISMA,97660,Bandrélé,CAD,-12.892461,45.202248
976030950H-6,6,RUE DISMA,97660,Bandrélé,CAD,-12.892383,45.202456
976030950H-8,8,RUE DISMA,97660,Bandrélé,CAD,-12.892300,45.202555
976030950H-9,9,RUE DISMA,97660,Bandrélé,CAD,-12.892355,45.202387
976030951J-103,103,RTE NATIONALE 3,97660,Bandrélé,CAD,-12.893639,45.201696
  \_ ID         |   \_ Street Name |         \     \_ Source  \_ Geo point
                |                  |          \
                |_ Street Number   |_ Zipcode  \_ City Name
</code></pre>
<h4 id=writing-the-logstash-pipeline>Writing the Logstash pipeline</h4>
<p>As everytime I&rsquo;m writing a Logstash pipeline, I&rsquo;m always starting with a basic configuration file, let&rsquo;s call it <code>bano-data.conf</code>:</p>
<pre><code class=language-ruby>input { 
  stdin { } 
}

filter {
}

output {
  stdout { codec =&gt; json }
}
</code></pre>
<p>Let&rsquo;s run it:</p>
<pre><code class=language-sh>head -1 | logstash-6.2.3/bin/logstash -f bano-data.conf
</code></pre>
<p>This gives something like:</p>
<pre><code class=language-json>{ 
  &quot;message&quot;:&quot;976030951J-103,103,RTE NATIONALE 3,97660,Bandrélé,CAD,-12.893639,45.201696&quot;,
  &quot;@timestamp&quot;:&quot;2017-12-05T16:00:00.000PST&quot;, 
  &quot;@version&quot;:1, 
  &quot;host&quot;:&quot;MacBook-Pro-David.local&quot;
}
</code></pre>
<p>Let&rsquo;s add our <code>csv-filter</code> plugin as we already saw in <a href=https://david.pilato.fr/blog/2015-04-28-exploring-capitaine-train-dataset/>Exploring Capitaine Train dataset</a>:</p>
<pre><code class=language-ruby>csv {
  separator =&gt; &quot;,&quot;
  columns =&gt; [
    &quot;id&quot;,&quot;number&quot;,&quot;street_name&quot;,&quot;zipcode&quot;,&quot;city&quot;,&quot;source&quot;,&quot;latitude&quot;,&quot;longitude&quot;
  ]
  remove_field =&gt; [ &quot;message&quot;, &quot;@version&quot;, &quot;@timestamp&quot;, &quot;host&quot; ]
}
</code></pre>
<p>That&rsquo;s now producing:</p>
<pre><code class=language-json>{ 
  &quot;source&quot;:&quot;CAD&quot;, 
  &quot;id&quot;:&quot;976030951J-103&quot;, 
  &quot;number&quot;:&quot;103&quot;, 
  &quot;street_name&quot;:&quot;RTE NATIONALE 3&quot;, 
  &quot;zipcode&quot;:&quot;97660&quot;, 
  &quot;city&quot;:&quot;Bandrélé&quot;, 
  &quot;latitude&quot;:&quot;-12.893639&quot;, 
  &quot;longitude&quot;:&quot;45.201696&quot; 
}
</code></pre>
<p>Let&rsquo;s rename and convert some fields with the <code>mutate-filter</code> plugin:</p>
<pre><code class=language-ruby>mutate {
  convert =&gt; { &quot;longitude&quot; =&gt; &quot;float&quot; }
  convert =&gt; { &quot;latitude&quot; =&gt; &quot;float&quot; }
  rename =&gt; {
    &quot;longitude&quot; =&gt; &quot;[location][lon]&quot;
    &quot;latitude&quot; =&gt; &quot;[location][lat]&quot;
    &quot;number&quot; =&gt; &quot;[address][number]&quot;
    &quot;street_name&quot; =&gt; &quot;[address][street_name]&quot;
    &quot;zipcode&quot; =&gt; &quot;[address][zipcode]&quot;
    &quot;city&quot; =&gt; &quot;[address][city]&quot;
  }
  replace =&gt; {
    &quot;region&quot; =&gt; &quot;${REGION}&quot;
  }
}
</code></pre>
<p>I&rsquo;ll explain a bit later where this <code>${REGION}</code> value is coming from.
But basically, I want to store here the department number the address is coming from.</p>
<p>This now gives:</p>
<pre><code class=language-json>{ 
  &quot;source&quot;:&quot;CAD&quot;,
  &quot;id&quot;:&quot;976030951J-103&quot;,
  &quot;region&quot;:&quot;976&quot;,
  &quot;address&quot;:{
    &quot;number&quot;:&quot;103&quot;, 
    &quot;street_name&quot;:&quot;RTE NATIONALE 3&quot;, 
    &quot;zipcode&quot;:&quot;97660&quot;, 
    &quot;city&quot;:&quot;Bandrélé&quot;
  },
  &quot;location&quot;:{
    &quot;lat&quot;:-12.893639,
    &quot;lon&quot;:45.201696
  }
}
</code></pre>
<p>We are almost done. Let&rsquo;s load elasticsearch now by adding our <code>elasticsearch-output</code> plugin:</p>
<pre><code class=language-ruby>elasticsearch {
  &quot;template_name&quot; =&gt; &quot;bano&quot;
  &quot;template_overwrite&quot; =&gt; true
  &quot;template&quot; =&gt; &quot;bano.json&quot;
  &quot;index&quot; =&gt; &quot;.bano-${REGION}&quot;
  &quot;document_id&quot; =&gt; &quot;%{[id]}&quot;
}
</code></pre>
<p>Few things to explore in that last code sample:</p>
<ul>
<li>We are providing an index template for elasticsearch.</li>
<li>We are setting the <code>_index</code> name to <code>.bano-${REGION}</code>. Again, we will explain later where this value is coming from.</li>
<li>We are setting the document <code>_id</code> to the <code>id</code> provided within the bano dataset.</li>
</ul>
<h4 id=bano-index-template>Bano index template</h4>
<p>As you can notice, we are using an index template here named <code>bano</code> which is loaded by logstash anytime the <code>elasticsearch</code> plugin starts. Using <code>template_overwrite</code> helps overwriting the template anytime you want to change some rules. Of course, overwriting an index template does not update the existing indices. So basically you will need to drop the existing indices and parse again the bano data with Logstash.</p>
<p>Let&rsquo;s describe what this index template contains:</p>
<pre><code class=language-json>{
  &quot;template&quot;: &quot;.bano-*&quot;, 
  &quot;settings&quot;: { /* ... */ },
  &quot;mappings&quot;: { /* ... */ },
  &quot;aliases&quot; : { /* ... */ }
}
</code></pre>
<p>This template will be applied anytime we have an index which name starts with <code>.bano-</code>. We will then apply 3 following parts:</p>
<ul>
<li><code>settings</code>: for index settings</li>
<li><code>mappings</code>: for document mapping</li>
<li><code>aliases</code>: for virtual indices (aka aliases)</li>
</ul>
<p>The <code>settings</code> part is the following:</p>
<pre><code class=language-json>{
  &quot;template&quot;: &quot;.bano-*&quot;, 
  &quot;settings&quot;: {
    &quot;index.number_of_shards&quot;: 1, 
    &quot;index.number_of_replicas&quot;: 0,
    &quot;index.analysis&quot;: {
      &quot;analyzer&quot;: {
        &quot;bano_analyzer&quot;: {  
          &quot;type&quot;: &quot;custom&quot;, 
          &quot;tokenizer&quot;: &quot;standard&quot;, 
          &quot;filter&quot; : [ &quot;lowercase&quot;, &quot;asciifolding&quot; ]
        },
        &quot;bano_street_analyzer&quot;: {
          &quot;type&quot;: &quot;custom&quot;, 
          &quot;tokenizer&quot;: &quot;standard&quot;, 
          &quot;filter&quot; : [ &quot;lowercase&quot;, &quot;asciifolding&quot;, &quot;bano_synonym&quot; ]
        }
      },
      &quot;filter&quot;: {
        &quot;bano_synonym&quot;: {
          &quot;type&quot;: &quot;synonym&quot;,
          &quot;synonyms&quot;: [
            &quot;bd =&gt; boulevard&quot;,
            &quot;av =&gt; avenue&quot;,
            &quot;r =&gt; rue&quot;,
            &quot;rte =&gt; route&quot;
          ]
        }
      }
    }
  },
  &quot;mappings&quot;: { /* ... */ },
  &quot;aliases&quot; : { /* ... */ }
}
</code></pre>
<p>Here, we want one single shard per index (per department) which is more than enough. We don&rsquo;t want replicas as we will be running that on a single node. Note that the number of replicas can be set dynamically so after the ingestion of the bano data, we can always increase this value if we decide to have a bigger cluster.</p>
<p>We are then defining two analyzers. The first one, <code>bano_analyzer</code>, is a kind of a <code>standard</code> analyzer but with addition of an <code>asciifolding</code> token filter which will transform at index time and search time all the french diatrics like for example <code>é</code>, <code>è</code>, <code>ê</code> to their ascii equivalent value: <code>e</code>.</p>
<p>The second analyzer named <code>bano_street_analyzer</code> adds also some synonyms. Indeed, when I looked at some values we have in the bano dataset, I found that sometimes the same type of street has different type names. Like <code>av</code> for <code>avenue</code>.
The <code>synonym</code> token filter will definitely help to normalize that.</p>
<p>As it will be used also at search time, it will help if for example a call center operator type <code>bd</code> instead of <code>boulevard</code> as it will be also normalized to the right value.</p>
<p>The <code>mappings</code> part is the following:</p>
<pre><code class=language-json>{
  &quot;template&quot;: &quot;.bano-*&quot;, 
  &quot;settings&quot;: { /* ... */ },
  &quot;mappings&quot;: {
    &quot;doc&quot;: {
      &quot;properties&quot; : {
        &quot;address&quot;: {
          &quot;properties&quot; : {
            &quot;city&quot;: {
              &quot;type&quot;: &quot;text&quot;,
              &quot;analyzer&quot;: &quot;bano_analyzer&quot;,
              &quot;fields&quot;: {
                &quot;keyword&quot;: {
                  &quot;type&quot;: &quot;keyword&quot;
                }
              }
            },
            &quot;number&quot;: {
              &quot;type&quot;: &quot;keyword&quot;
            },
            &quot;street_name&quot;: {
              &quot;type&quot;: &quot;text&quot;,
              &quot;analyzer&quot;: &quot;bano_street_analyzer&quot;
            },
            &quot;zipcode&quot;: {
              &quot;type&quot;: &quot;keyword&quot;
            }
          }
        },
        &quot;region&quot;: {
          &quot;type&quot;: &quot;keyword&quot;
        },
        &quot;id&quot;: {
          &quot;type&quot;: &quot;keyword&quot;
        },
        &quot;source&quot;: {
          &quot;type&quot;: &quot;keyword&quot;
        },
        &quot;location&quot;: {
          &quot;type&quot;: &quot;geo_point&quot;
        }
      }
    }
  },
  &quot;aliases&quot; : { /* ... */ }
}
</code></pre>
<p>Everything is pretty much obvious here. For some fields we are using a <code>keyword</code> data type as we just want to run exact match or aggregations.
The <code>street_name</code> is using the <code>bano_street_analyzer</code> we saw before.
<code>city</code> is indexed twice:</p>
<ul>
<li>As <code>city</code> field to perform full text search on it.</li>
<li>As <code>city.keyword</code> field to perform a terms aggregation on it.</li>
</ul>
<p>Finally <code>location</code> is a <code>geo_point</code> type.</p>
<p>The <code>aliases</code> part is the following:</p>
<pre><code class=language-json>{
  &quot;template&quot;: &quot;.bano-*&quot;, 
  &quot;settings&quot;: { /* ... */ },
  &quot;mappings&quot;: { /* ... */ },
  &quot;aliases&quot; : {
    &quot;.bano&quot; : {}
  }
}
</code></pre>
<p>It means that if we don&rsquo;t know the department when we have to search, we can search in <code>.bano</code> virtual index which will behind the scene query all bano indices. Of course, we could have been using a wildcard when searching as well like:</p>
<pre><code class=language-json>GET .bano-*/_search
</code></pre>
<h4 id=loading-data>Loading data</h4>
<p>To launch our importation, let&rsquo;s write a shell script:</p>
<pre><code class=language-sh>import_region () {
    export REGION=$1
    FILE=bano-data/bano-$REGION.csv
    curl -XDELETE localhost:9200/.bano-$REGION?pretty
    cat $FILE | logstash-6.2.3/bin/logstash -f bano-data.conf
}

DEPTS=95
for i in {01..19} $(seq 21 $DEPTS) {971..974} {976..976} ; do
    DEPT=$(printf %02d $i)
    import_region $DEPT
done
</code></pre>
<p>We are using here the same tricks for the strange department numbers.
In <code>import_region</code> we are exporting the department number as <code>REGION</code> system property which logstash is then able to use.</p>
<p>For each CSV file, we basically:</p>
<ul>
<li>Remove the existing index if any</li>
<li>cat the content of the file and send the content to Logstash</li>
</ul>
<p>We could have been a bit smarter and we could have been using instead an <code>http</code> input plugin which just waits for documents coming on port <code>8080</code>. We will cover that in a next section.</p>
<p>It took something like 2 hours and a half to inject the data on my laptop but I now have data ready&mldr;</p>
<h2 id=bano-statistics>Bano statistics</h2>
<p>So what do we have now?</p>
<pre><code class=language-json>GET _cat/indices/.bano*?v&amp;h=index,docs.count,store.size
</code></pre>
<p>Gives (only the first lines are shown here):</p>
<pre><code class=language-txt>index     docs.count store.size
.bano-80      204930     20.7mb
.bano-50      160820     16.4mb
.bano-60      241276     24.6mb
.bano-34      308056     30.9mb
</code></pre>
<p>How many addresses do we have?</p>
<pre><code class=language-json>GET .bano/_search
{
  &quot;size&quot;: 0
}
</code></pre>
<p>Gives:</p>
<pre><code class=language-json>{
  &quot;took&quot;: 24,
  &quot;timed_out&quot;: false,
  &quot;_shards&quot;: {
    &quot;total&quot;: 99,
    &quot;successful&quot;: 99,
    &quot;skipped&quot;: 0,
    &quot;failed&quot;: 0
  },
  &quot;hits&quot;: {
    &quot;total&quot;: 16402853,
    &quot;max_score&quot;: 0,
    &quot;hits&quot;: []
  }
}
</code></pre>
<p>So we have <code>16.402.853</code> addresses.</p>
<p>Let&rsquo;s look at that from Kibana. Here I built really simple visualizations.</p>
<figure><img src=bano-regions.png alt="Distribution of Bano addresses by department number"><figcaption>
<p>Distribution of Bano addresses by department number</p>
</figcaption>
</figure>
<figure><img src=bano-fr.png alt="Map of Bano addresses for France Metropolitan"><figcaption>
<p>Map of Bano addresses for France Metropolitan</p>
</figcaption>
</figure>
<figure><img src=bano-dom.png alt="Map of Bano addresses for some France Overseas Departments"><figcaption>
<p>Map of Bano addresses for some France Overseas Departments</p>
</figcaption>
</figure>
<figure><img src=bano-lr.png alt="Map of Bano addresses near by La Rochelle"><figcaption>
<p>Map of Bano addresses near by La Rochelle</p>
</figcaption>
</figure>
<figure><img src=bano-cities.png alt="Top cities (in number of known addresses"><figcaption>
<p>Top cities (in number of known addresses</p>
</figcaption>
</figure>
<p>No surprise in this list. It&rsquo;s common to say that biggest cities in term of population are:</p>
<ul>
<li>Paris</li>
<li>Marseille</li>
<li>Toulouse</li>
<li>Bordeaux</li>
<li>Nantes</li>
</ul>
<h2 id=next-steps>Next steps</h2>
<p>Have a look at the <a href=https://david.pilato.fr/blog/2018-03-23-enriching-your-postal-addresses-with-elastic-stack-part-2/>next post</a> to see how you can now use that dataset to perform address correction and transformation.</p>
</div>
<div class=my-4>
<a href=https://david.pilato.fr/tags/logstash/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#logstash</a>
<a href=https://david.pilato.fr/tags/elasticsearch/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#elasticsearch</a>
</div>
<div class=py-2>
<div class="flex flex-col md:flex-row items-center my-8">
<a href=https://david.pilato.fr/authors/david-pilato/ class="w-24 h-24 md:mr-4">
<img src=https://david.pilato.fr/authors/david-pilato/david_pilato.png class="w-full bg-primary-bg rounded-full" alt=Avatar>
</a>
<div class="w-full md:w-auto mt-4 md:mt-0">
<a href=https://david.pilato.fr/authors/david-pilato/ class="block font-bold text-lg pb-1 mb-2 border-b">David Pilato</a>
<span class="block pb-2">20+ years of experience, mostly in Java. Living in Cergy, France.</span>
<a href=mailto:david+blog@pilato.fr class=mr-1>
<i class="fas fa-envelope"></i>
</a>
<a href=https://twitter.com/dadoonet class=mr-1>
<i class="fab fa-twitter"></i>
</a>
<a href=https://github.com/dadoonet class=mr-1>
<i class="fab fa-github"></i>
</a>
<a href=https://www.linkedin.com/in/dadoonet/ class=mr-1>
<i class="fab fa-linkedin"></i>
</a>
</div>
</div>
</div>
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
<div>
<span class="block font-bold">Previous</span>
<a href=https://david.pilato.fr/blog/2018-03-23-enriching-your-postal-addresses-with-elastic-stack-part-2/ class=block>Enriching your postal addresses with Elastic stack - part 2</a>
</div>
<div class="md:text-right mt-4 md:mt-0">
<span class="block font-bold">Next</span>
<a href=https://david.pilato.fr/blog/2018-01-10-5-years-what-a-milestone/ class=block>5 years. What a milestone!</a>
</div>
</div>
</div>
<div class=col-span-2>
<div class="bg-secondary-bg rounded p-6">
<h3 class="text-lg font-semibold mb-4">Series of Posts</h3>
<div class=content>
<a href=https://david.pilato.fr/blog/2018-03-24-enriching-your-postal-addresses-with-elastic-stack-part-3/>Enriching your postal addresses with Elastic stack - part 3</a>
<br>
<a href=https://david.pilato.fr/blog/2018-03-23-enriching-your-postal-addresses-with-elastic-stack-part-2/>Enriching your postal addresses with Elastic stack - part 2</a>
<br>
<a href=https://david.pilato.fr/blog/2018-03-22-enriching-your-postal-addresses-with-elastic-stack-part-1/>Enriching your postal addresses with Elastic stack - part 1</a>
<br>
</div>
</div>
<div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-primary-bg">
<span class="text-lg font-semibold">On This Page</span>
</div>
<div class="sticky-toc hidden lg:block px-6 pb-6">
<nav id=TableOfContents>
<ul>
<li><a href=#bano>Bano</a>
<ul>
<li><a href=#download-bano-csv-files>Download Bano CSV files</a></li>
<li><a href=#loading-elasticsearch>Loading elasticsearch</a>
<ul>
<li><a href=#writing-the-logstash-pipeline>Writing the Logstash pipeline</a></li>
<li><a href=#bano-index-template>Bano index template</a></li>
<li><a href=#loading-data>Loading data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#bano-statistics>Bano statistics</a></li>
<li><a href=#next-steps>Next steps</a></li>
</ul>
</nav>
</div>
<script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc()})</script>
</div>
<div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded p-6">
<h2 class="text-lg font-semibold mb-4">See Also</h2>
<div class=content>
<a href=https://david.pilato.fr/blog/2016-01-05-understanding-zipfs-law/>Understanding Zipf's law</a>
<br>
<a href=https://david.pilato.fr/blog/2015-12-10-building-a-directory-map-with-elk/>Building a directory map with ELK</a>
<br>
<a href=https://david.pilato.fr/blog/2015-11-17-index-twitter-on-found/>Index Twitter on found</a>
<br>
<a href=https://david.pilato.fr/blog/2015-09-14-import-from-sql-without-database/>Importing from a database without a database</a>
<br>
<a href=https://david.pilato.fr/blog/2015-06-01-indexing-twitter-with-logstash-and-elasticsearch/>Indexing Twitter with Logstash and Elasticsearch</a>
<br>
<a href=https://david.pilato.fr/blog/2015-05-20-reindex-elasticsearch-with-logstash/>Reindex elasticsearch with Logstash</a>
<br>
</div>
</div>
</div>
<script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script>
</div>
</div>
</main>
<footer class=pl-scrollbar>
<div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
<p class="text-sm text-tertiary-text">&copy; 2022, David Pilato, France
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p>
</div></div>
</footer>
</body>
</html>