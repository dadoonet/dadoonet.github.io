<!doctype html><html lang=en><meta charset=utf-8>
<meta name=viewport content="width=device-width">
<title>Elasticsearch real integration tests - David Pilato</title>
<meta name=generator content="Hugo Eureka 0.8.4">
<link rel=stylesheet href=https://david.pilato.fr/css/eureka.min.css>
<script defer src=https://david.pilato.fr/js/eureka.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'">
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script>
<link rel=preconnect href=https://www.google-analytics.com crossorigin>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-62381049-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-62381049-1')</script>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Elasticsearch real integration tests">
<meta name=twitter:description content="NOTE: This article is now outdated. Please read Elasticsearch real integration tests (Updated for GA) instead!
Integration tests&mldr; How do you run them?
Often, you are tempted to run services you want to test from JUnit for example. In elasticsearch, you can extend ESIntegTestCase class which will start a cluster of a given number of nodes.
public class BanoPluginIntegrationTest extends ESIntegTestCase { public void testPluginIsLoaded() throws Exception { // Your code here } }  But to be honest, the test you are running does not guarantee that you will have the same result in production.">
<meta name=description content="NOTE: This article is now outdated. Please read Elasticsearch real integration tests (Updated for GA) instead!
Integration tests&mldr; How do you run them?
Often, you are tempted to run services you want to test from JUnit for example. In elasticsearch, you can extend ESIntegTestCase class which will start a cluster of a given number of nodes.
public class BanoPluginIntegrationTest extends ESIntegTestCase { public void testPluginIsLoaded() throws Exception { // Your code here } }  But to be honest, the test you are running does not guarantee that you will have the same result in production.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://david.pilato.fr/blog/"},{"@type":"ListItem","position":2,"name":"Elasticsearch real integration tests","item":"https://david.pilato.fr/blog/2016-07-29-elasticsearch-real-integration-tests/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://david.pilato.fr/blog/2016-07-29-elasticsearch-real-integration-tests/"},"headline":"Elasticsearch real integration tests - David Pilato","datePublished":"2016-07-29T03:02:48+02:00","dateModified":"2016-07-29T03:02:48+02:00","wordCount":2699,"author":{"@type":"Person","name":["David Pilato"]},"publisher":{"@type":"Person","name":"David Pilato"},"description":"NOTE: This article is now outdated. Please read Elasticsearch real integration tests (Updated for GA) instead!\nIntegration tests\u0026hellip; How do you run them?\nOften, you are tempted to run services you want to test from JUnit for example. In elasticsearch, you can extend ESIntegTestCase class which will start a cluster of a given number of nodes.\npublic class BanoPluginIntegrationTest extends ESIntegTestCase { public void testPluginIsLoaded() throws Exception { \/\/ Your code here } }  But to be honest, the test you are running does not guarantee that you will have the same result in production."}</script><meta property="og:title" content="Elasticsearch real integration tests - David Pilato">
<meta property="og:type" content="article">
<meta property="og:url" content="https://david.pilato.fr/blog/2016-07-29-elasticsearch-real-integration-tests/">
<meta property="og:description" content="NOTE: This article is now outdated. Please read Elasticsearch real integration tests (Updated for GA) instead!
Integration tests&mldr; How do you run them?
Often, you are tempted to run services you want to test from JUnit for example. In elasticsearch, you can extend ESIntegTestCase class which will start a cluster of a given number of nodes.
public class BanoPluginIntegrationTest extends ESIntegTestCase { public void testPluginIsLoaded() throws Exception { // Your code here } }  But to be honest, the test you are running does not guarantee that you will have the same result in production.">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="David Pilato">
<meta property="article:published_time" content="2016-07-29T03:02:48+02:00">
<meta property="article:modified_time" content="2016-07-29T03:02:48+02:00">
<meta property="article:section" content="blog">
<meta property="article:tag" content="java">
<meta property="article:tag" content="maven">
<meta property="article:tag" content="ant">
<meta property="article:tag" content="test">
<meta property="article:tag" content="elasticsearch">
<meta property="article:tag" content="plugin">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2016-08-03-elasticsearch-real-integration-tests-with-security-enabled/">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2016-08-01-creating-elasticsearch-transport-action/">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2016-07-30-adding-a-new-rest-endpoint-to-elasticsearch/">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2016-07-28-creating-an-ingest-plugin-for-elasticsearch/">
<meta property="og:see_also" content="https://david.pilato.fr/blog/2016-07-27-creating-a-plugin-for-elasticsearch-5-dot-0-using-maven/">
<body class="flex flex-col min-h-screen">
<header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
<div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
<a href=/ class="mr-6 text-primary-text text-xl font-bold">David Pilato</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i>
</button>
<div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
<div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
<a href=/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Home</a>
<a href=/blog/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Blog</a>
<a href=https://djdadoo.pilato.fr/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">DJ Mixes</a>
<a href=/authors/david-pilato/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">About me</a>
</div>
<div class=flex>
<div class="relative pt-4 md:pt-0">
<div class="cursor-pointer hover:text-eureka" id=lightDarkMode>
<i class="fas fa-adjust"></i>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open>
</div>
<div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions>
<span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span>
</div>
</div>
</div>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile>
</div>
</nav>
<script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script>
</div>
</header>
<main class="flex-grow pt-16">
<div class=pl-scrollbar>
<div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">
<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
<div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
<h1 class="font-bold text-3xl text-primary-text">Elasticsearch real integration tests</h1>
<div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
<div class="mr-6 my-2">
<i class="fas fa-calendar mr-1"></i>
<span>2016-07-29</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-clock mr-1"></i>
<span>13 min read</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-folder mr-1"></i>
<a href=https://david.pilato.fr/categories/tutorial/ class=hover:text-eureka>tutorial</a>
</div>
<div class="mr-6 my-2">
<i class="fas fa-th-list mr-1"></i>
<a href=https://david.pilato.fr/series/plugin-for-elasticsearch-v5/ class=hover:text-eureka>plugin for elasticsearch v5</a>
</div>
</div>
<div class=content>
<p><strong>NOTE:</strong> This article is now outdated. Please read <a href=https://david.pilato.fr/blog/2016-10-18-elasticsearch-real-integration-tests-updated-for-ga/>Elasticsearch real integration tests (Updated for GA)</a> instead!</p>
<p>Integration tests&mldr; How do you run them?</p>
<p>Often, you are tempted to run services you want to test from JUnit for example.
In elasticsearch, you can extend <code>ESIntegTestCase</code> class which will start a cluster of a given
number of nodes.</p>
<pre><code class=language-java>public class BanoPluginIntegrationTest extends ESIntegTestCase {
    public void testPluginIsLoaded() throws Exception {
        // Your code here
    }
}
</code></pre>
<p>But to be honest, the test you are running does not guarantee that you will have the same
result in production.</p>
<p>Why this? Because some services might be disabled, some others might be mocked.</p>
<p>Instead, running tests against a real cluster as the one you would install locally on your machine
is the way to go.</p>
<p>Let&rsquo;s see how you can do that with Maven&mldr;</p>
<h2 id=how-do-we-want-to-test>How do we want to test?</h2>
<p>Ideally, we want to:</p>
<ul>
<li>download elasticsearch 5.0.0-alpha5 version</li>
<li>unzip it</li>
<li>install the plugin we are building if this is what we are doing</li>
<li>install any other plugin we could need for the tests</li>
<li>launch elasticsearch</li>
<li>run our integration tests against this cluster</li>
<li>stop the cluster at the end</li>
</ul>
<p>We want to do that during maven integration test phase. No need to do that every time.
Also, we might want to be able to run the tests from our IDE against an external cluster we installed manually.</p>
<h3 id=separated-skiptests>Separated skipTests</h3>
<p>If we want to be able to skip either unit tests or integration tests, we can
define 3 properties in our <code>pom.xml</code>:</p>
<pre><code class=language-xml>&lt;skipTests&gt;false&lt;/skipTests&gt;
&lt;skipUnitTests&gt;${skipTests}&lt;/skipUnitTests&gt;
&lt;skipIntegTests&gt;${skipTests}&lt;/skipIntegTests&gt;
</code></pre>
<h3 id=writing-a-ant-script>Writing a ANT script</h3>
<p>Elasticsearch team wrote an ANT script to achieve some of the goals we described before.
You can read the original script I used <a href=https://github.com/elastic/elasticsearch/blob/2.4/dev-tools/src/main/resources/ant/integration-tests.xml>on github</a>.</p>
<p>You can put this <code>integration-tests.xml</code> file in <code>src/test/ant/</code> for example:</p>
<pre><code class=language-xml>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;project name=&quot;integration-tests&quot; xmlns:if=&quot;ant:if&quot; xmlns:unless=&quot;ant:unless&quot;&gt;
    &lt;!-- our pid file for easy cleanup --&gt;
    &lt;property name=&quot;integ.pidfile&quot; location=&quot;${project.build.directory}/integration-tests/run/es.pid&quot;/&gt;

    &lt;!-- if this exists, ES is running (maybe) --&gt;
    &lt;available property=&quot;integ.pidfile.exists&quot; file=&quot;${integ.pidfile}&quot;/&gt;

    &lt;!-- name of our cluster, maybe needs changing --&gt;
    &lt;property name=&quot;integ.cluster.name&quot; value=&quot;elasticsearch_integration&quot;/&gt;

    &lt;!-- runs an OS script --&gt;
    &lt;macrodef name=&quot;run-script&quot;&gt;
        &lt;attribute name=&quot;script&quot;/&gt;
        &lt;attribute name=&quot;spawn&quot; default=&quot;false&quot;/&gt;
        &lt;element name=&quot;nested&quot; optional=&quot;true&quot;/&gt;
        &lt;sequential&gt;
            &lt;local name=&quot;failonerror&quot;/&gt;
            &lt;condition property=&quot;failonerror&quot;&gt;
                &lt;isfalse value=&quot;@{spawn}&quot;/&gt;
            &lt;/condition&gt;

            &lt;!-- create a temp CWD, to enforce that commands don't rely on CWD --&gt;
            &lt;local name=&quot;temp.cwd&quot;/&gt;
            &lt;tempfile property=&quot;temp.cwd&quot; destDir=&quot;${project.build.directory}/integration-tests/run/tmp&quot; deleteonexit=&quot;true&quot;/&gt;
            &lt;mkdir dir=&quot;${temp.cwd}&quot;/&gt;

            &lt;!-- print commands we run --&gt;
            &lt;local name=&quot;script.base&quot;/&gt;
            &lt;basename file=&quot;@{script}&quot; property=&quot;script.base&quot;/&gt;
            &lt;!-- crappy way to output, but we need it. make it nice later --&gt;
            &lt;echoxml&gt;&lt;exec script=&quot;${script.base}&quot;&gt;&lt;nested/&gt;&lt;/exec&gt;&lt;/echoxml&gt;
            &lt;exec executable=&quot;cmd&quot; osfamily=&quot;winnt&quot; dir=&quot;${temp.cwd}&quot; failonerror=&quot;${failonerror}&quot; spawn=&quot;@{spawn}&quot; taskname=&quot;${script.base}&quot;&gt;
                &lt;arg value=&quot;/c&quot;/&gt;
                &lt;arg value=&quot;&amp;quot;&quot;/&gt;
                &lt;arg value=&quot;@{script}.bat&quot;/&gt;
                &lt;nested/&gt;
                &lt;arg value=&quot;&amp;quot;&quot;/&gt;
            &lt;/exec&gt;

            &lt;exec executable=&quot;bash&quot; osfamily=&quot;unix&quot; dir=&quot;${temp.cwd}&quot; failonerror=&quot;${failonerror}&quot; spawn=&quot;@{spawn}&quot; taskname=&quot;${script.base}&quot;&gt;
                &lt;arg value=&quot;@{script}&quot;/&gt;
                &lt;nested/&gt;
            &lt;/exec&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;

    &lt;!-- extracts PID from file --&gt;
    &lt;macrodef name=&quot;extract-pid&quot;&gt;
        &lt;attribute name=&quot;file&quot;/&gt;
        &lt;attribute name=&quot;property&quot;/&gt;
        &lt;sequential&gt;
            &lt;loadfile srcFile=&quot;@{file}&quot; property=&quot;@{property}&quot;&gt;
                &lt;filterchain&gt;
                    &lt;striplinebreaks/&gt;
                &lt;/filterchain&gt;
            &lt;/loadfile&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;

    &lt;!-- applies transformations to src and stores in dst --&gt;
    &lt;macrodef name=&quot;filter-property&quot;&gt;
        &lt;attribute name=&quot;src&quot;/&gt;
        &lt;attribute name=&quot;dest&quot;/&gt;
        &lt;element name=&quot;chain&quot;/&gt;
        &lt;sequential&gt;
            &lt;loadresource property=&quot;@{dest}&quot;&gt;
                &lt;propertyresource name=&quot;@{src}&quot;/&gt;
                &lt;filterchain&gt;
                    &lt;tokenfilter&gt;
                        &lt;chain/&gt;
                    &lt;/tokenfilter&gt;
                &lt;/filterchain&gt;
            &lt;/loadresource&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;

    &lt;!-- waits for elasticsearch to start --&gt;
    &lt;macrodef name=&quot;waitfor-elasticsearch&quot;&gt;
        &lt;attribute name=&quot;port&quot;/&gt;
        &lt;attribute name=&quot;timeoutproperty&quot;/&gt;
        &lt;sequential&gt;
            &lt;echo&gt;Waiting for elasticsearch to become available on port @{port}...&lt;/echo&gt;
            &lt;waitfor maxwait=&quot;30&quot; maxwaitunit=&quot;second&quot;
                     checkevery=&quot;500&quot; checkeveryunit=&quot;millisecond&quot;
                     timeoutproperty=&quot;@{timeoutproperty}&quot;&gt;
                &lt;http url=&quot;http://localhost:@{port}&quot;/&gt;
            &lt;/waitfor&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;

    &lt;scriptdef name=&quot;isGreater&quot; language=&quot;javascript&quot;&gt;
        &lt;attribute name=&quot;v1&quot;/&gt;
        &lt;attribute name=&quot;v2&quot;/&gt;
        &lt;![CDATA[

            var i, l, d, s = false;

            a = attributes.get(&quot;v1&quot;).split('.');
            b = attributes.get(&quot;v2&quot;).split('.');
            l = Math.min(a.length, b.length);

            for (i=0; i&lt;l; i++) {
                d = parseInt(a[i], 10) - parseInt(b[i], 10);
                if (d !== 0) {
                    project.setProperty(&quot;compare-result&quot;, d &gt; 0);
                    s = true;
                    break;
                }
            }

            if(!s){
                d = a.length - b.length;
                project.setProperty(&quot;compare-result&quot;, d &gt;= 0);
            }

            ]]&gt;
    &lt;/scriptdef&gt;

    &lt;!-- start elasticsearch and wait until its ready --&gt;
    &lt;macrodef name=&quot;startup-elasticsearch&quot;&gt;
        &lt;attribute name=&quot;home&quot; default=&quot;${project.build.directory}/integration-tests/run/elasticsearch-${elasticsearch.version}&quot;/&gt;
        &lt;attribute name=&quot;spawn&quot; default=&quot;true&quot;/&gt;
        &lt;attribute name=&quot;es.cluster.name&quot; default=&quot;${integ.cluster.name}&quot;/&gt;
        &lt;attribute name=&quot;es.http.port&quot; default=&quot;${integ.http.port}&quot;/&gt;
        &lt;attribute name=&quot;es.transport.tcp.port&quot; default=&quot;${integ.transport.port}&quot;/&gt;
        &lt;attribute name=&quot;es.pidfile&quot; default=&quot;${integ.pidfile}&quot;/&gt;
        &lt;element name=&quot;additional-args&quot; optional=&quot;true&quot;/&gt;
        &lt;sequential&gt;
            &lt;!-- make sure no elasticsearch instance is currently running and listening on the port we need --&gt;
            &lt;fail message=&quot;This test expects port @{es.http.port} to be free but an elasticsearch instance is already running and listening on that port.
      Maybe the last test run did not manage to shut down the node correctly?
      You must kill it before tests can run.&quot;&gt;
                &lt;condition&gt;
                    &lt;socket server=&quot;localhost&quot; port=&quot;@{es.http.port}&quot;&gt;&lt;/socket&gt;
                &lt;/condition&gt;
            &lt;/fail&gt;
            &lt;!-- run bin/elasticsearch with args --&gt;
            &lt;echo&gt;Starting up external cluster...&lt;/echo&gt;
            &lt;isGreater v1=&quot;${elasticsearch.version}&quot; v2=&quot;5.0.0&quot; /&gt;

            &lt;echo if:true=&quot;${compare-result}&quot;&gt;running Elasticsearch 5.0.0 or superior&lt;/echo&gt;
            &lt;echo unless:true=&quot;${compare-result}&quot;&gt;running Elasticsearch &amp;lt; 5.0.0&lt;/echo&gt;

            &lt;run-script script=&quot;@{home}/bin/elasticsearch&quot;
                        spawn=&quot;@{spawn}&quot;&gt;
                &lt;nested&gt;
                    &lt;arg value=&quot;-Des.pidfile=@{es.pidfile}&quot; unless:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Des.cluster.name=@{es.cluster.name}&quot; unless:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Des.http.port=@{es.http.port}&quot; unless:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Des.transport.tcp.port=@{es.transport.tcp.port}&quot; unless:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Des.network.host=127.0.0.1&quot; unless:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Epidfile=@{es.pidfile}&quot; if:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Ecluster.name=@{es.cluster.name}&quot; if:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Ehttp.port=@{es.http.port}&quot; if:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Etransport.tcp.port=@{es.transport.tcp.port}&quot; if:true=&quot;${compare-result}&quot;/&gt;
                    &lt;arg value=&quot;-Enetwork.host=127.0.0.1&quot; if:true=&quot;${compare-result}&quot;/&gt;
                    &lt;additional-args/&gt;
                &lt;/nested&gt;
            &lt;/run-script&gt;

            &lt;!-- wait for startup --&gt;
            &lt;local name=&quot;failed.to.start&quot;/&gt;
            &lt;waitfor-elasticsearch port=&quot;@{es.http.port}&quot;
                                   timeoutproperty=&quot;failed.to.start&quot;/&gt;

            &lt;!-- best effort, print console log. useful if it fails especially --&gt;
            &lt;local name=&quot;log.contents&quot;/&gt;
            &lt;loadfile srcFile=&quot;@{home}/logs/@{es.cluster.name}.log&quot;
                      property=&quot;log.contents&quot;
                      failonerror=&quot;false&quot;/&gt;
            &lt;echo message=&quot;${log.contents}&quot; taskname=&quot;elasticsearch&quot;/&gt;

            &lt;fail message=&quot;ES instance did not start&quot; if=&quot;failed.to.start&quot;/&gt;

            &lt;local name=&quot;integ.pid&quot;/&gt;
            &lt;extract-pid file=&quot;@{es.pidfile}&quot; property=&quot;integ.pid&quot;/&gt;
            &lt;echo&gt;External node started PID ${integ.pid}&lt;/echo&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;

    &lt;macrodef name=&quot;stop-node&quot;&gt;
        &lt;attribute name=&quot;es.pidfile&quot; default=&quot;${integ.pidfile}&quot;/&gt;
        &lt;sequential&gt;
            &lt;local name=&quot;integ.pid&quot;/&gt;

            &lt;extract-pid file=&quot;@{es.pidfile}&quot; property=&quot;integ.pid&quot;/&gt;
            &lt;echo&gt;Shutting down external node PID ${integ.pid}&lt;/echo&gt;
            &lt;!-- verify with jps that this actually is the correct pid.
            See if we can find the line &quot;pid org.elasticsearch.bootstrap.Elasticsearch&quot; in the output of jps -l.--&gt;
            &lt;local name=&quot;jps.pidline&quot;/&gt;
            &lt;local name=&quot;jps.executable&quot;/&gt;
            &lt;local name=&quot;environment&quot;/&gt;
            &lt;property environment=&quot;environment&quot;/&gt;
            &lt;property name=&quot;jps.executable&quot; location=&quot;${environment.JAVA_HOME}/bin/jps&quot;/&gt;
            &lt;exec executable=&quot;${jps.executable}&quot; failonerror=&quot;true&quot;&gt;
                &lt;arg value=&quot;-l&quot;/&gt;
                &lt;redirector outputproperty=&quot;jps.pidline&quot;&gt;
                    &lt;outputfilterchain&gt;
                        &lt;linecontains&gt;
                            &lt;contains value=&quot;${integ.pid} org.elasticsearch.bootstrap.Elasticsearch&quot;/&gt;
                        &lt;/linecontains&gt;
                    &lt;/outputfilterchain&gt;
                &lt;/redirector&gt;
            &lt;/exec&gt;
            &lt;fail
                    message=&quot;pid file at @{es.pidfile} is ${integ.pid} but jps -l did not report any process with org.elasticsearch.bootstrap.Elasticsearch and this pid.
          Did you run mvn clean? Maybe an old pid file is still lying around.&quot;&gt;
                &lt;condition&gt;
                    &lt;equals arg1=&quot;${jps.pidline}&quot; arg2=&quot;&quot;/&gt;
                &lt;/condition&gt;
            &lt;/fail&gt;

            &lt;exec executable=&quot;taskkill&quot; failonerror=&quot;true&quot; osfamily=&quot;winnt&quot;&gt;
                &lt;arg value=&quot;/F&quot;/&gt;
                &lt;arg value=&quot;/PID&quot;/&gt;
                &lt;arg value=&quot;${integ.pid}&quot;/&gt;
            &lt;/exec&gt;
            &lt;exec executable=&quot;kill&quot; failonerror=&quot;true&quot; osfamily=&quot;unix&quot;&gt;
                &lt;arg value=&quot;-9&quot;/&gt;
                &lt;arg value=&quot;${integ.pid}&quot;/&gt;
            &lt;/exec&gt;
            &lt;delete file=&quot;@{es.pidfile}&quot;/&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;

    &lt;target name=&quot;stop-external-cluster&quot; if=&quot;integ.pidfile.exists&quot;&gt;
        &lt;stop-node/&gt;
    &lt;/target&gt;

    &lt;target name=&quot;setup-workspace&quot; depends=&quot;stop-external-cluster&quot;&gt;
        &lt;sequential&gt;
            &lt;delete dir=&quot;${project.build.directory}/integration-tests/run&quot;/&gt;
            &lt;unzip src=&quot;${project.build.directory}/integration-tests/binaries/elasticsearch-${elasticsearch.version}.zip&quot;
                   dest=&quot;${project.build.directory}/integration-tests/run&quot;/&gt;
        &lt;/sequential&gt;
    &lt;/target&gt;

    &lt;target name=&quot;start-external-cluster&quot; depends=&quot;setup-workspace&quot;&gt;
        &lt;startup-elasticsearch/&gt;
    &lt;/target&gt;

    &lt;!-- unzip integ test artifact, install plugin, then start ES --&gt;
    &lt;target name=&quot;start-external-cluster-with-plugin&quot; depends=&quot;setup-workspace&quot;&gt;
        &lt;install-plugin name=&quot;${project.artifactId}&quot; file=&quot;${project.build.directory}/releases/${project.artifactId}-${project.version}.zip&quot;/&gt;
        &lt;startup-elasticsearch/&gt;
    &lt;/target&gt;

    &lt;!-- installs a plugin into elasticsearch --&gt;
    &lt;macrodef name=&quot;install-plugin&quot;&gt;
        &lt;attribute name=&quot;home&quot; default=&quot;${project.build.directory}/integration-tests/run/elasticsearch-${elasticsearch.version}&quot;/&gt;
        &lt;attribute name=&quot;name&quot;/&gt;
        &lt;attribute name=&quot;file&quot;/&gt;
        &lt;sequential&gt;
            &lt;local name=&quot;url&quot;/&gt;
            &lt;makeurl property=&quot;url&quot; file=&quot;@{file}&quot;/&gt;

            &lt;isGreater v1=&quot;${elasticsearch.version}&quot; v2=&quot;5.0.0&quot; /&gt;
            &lt;property name=&quot;commandline&quot; value=&quot;@{home}/bin/plugin&quot; unless:true=&quot;${compare-result}&quot;/&gt;
            &lt;property name=&quot;commandline&quot; value=&quot;@{home}/bin/elasticsearch-plugin&quot; if:true=&quot;${compare-result}&quot;/&gt;

            &lt;!-- install plugin --&gt;
            &lt;echo&gt;Installing plugin @{name}...&lt;/echo&gt;
            &lt;run-script script=&quot;${commandline}&quot;&gt;
                &lt;nested&gt;
                    &lt;arg value=&quot;install&quot;/&gt;
                    &lt;arg value=&quot;${url}&quot;/&gt;
                &lt;/nested&gt;
            &lt;/run-script&gt;

            &lt;fail message=&quot;did not find plugin installed as @{name}&quot;&gt;
                &lt;condition&gt;
                    &lt;not&gt;
                        &lt;resourceexists&gt;
                            &lt;file file=&quot;@{home}/plugins/@{name}&quot;/&gt;
                        &lt;/resourceexists&gt;
                    &lt;/not&gt;
                &lt;/condition&gt;
            &lt;/fail&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;
&lt;/project&gt;
</code></pre>
<p>This script provides 3 main tasks:</p>
<ul>
<li><code>start-external-cluster</code>: Unzip elasticsearch then starts a node</li>
<li><code>start-external-cluster-with-plugin</code>: Unzip elasticsearch, install a plugin then starts a node</li>
<li><code>stop-external-cluster</code>: Stop the running node</li>
</ul>
<p>It also takes into account the version you are using as options/settings might change between major versions.
So this script has been tested against elasticsearch 1.x, 2.x and 5.x series.</p>
<h3 id=download-elasticsearch>Download elasticsearch</h3>
<p>You can use Maven dependency plugin for that.</p>
<p>Define some properties first:</p>
<pre><code class=language-xml>&lt;elasticsearch.groupid&gt;org.elasticsearch.distribution.zip&lt;/elasticsearch.groupid&gt;
&lt;elasticsearch.version&gt;5.0.0-alpha5&lt;/elasticsearch.version&gt;
&lt;skipTests&gt;false&lt;/skipTests&gt;

&lt;!-- For integration tests using ANT --&gt;
&lt;integ.http.port&gt;9400&lt;/integ.http.port&gt;
&lt;integ.transport.port&gt;9500&lt;/integ.transport.port&gt;
</code></pre>
<p>Then add the dependency plugin:</p>
<pre><code class=language-xml>&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.10&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;integ-setup-dependencies&lt;/id&gt;
            &lt;phase&gt;pre-integration-test&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;copy&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
                &lt;skip&gt;${skipIntegTests}&lt;/skip&gt;
                &lt;artifactItems&gt;
                    &lt;artifactItem&gt;
                        &lt;groupId&gt;${elasticsearch.groupid}&lt;/groupId&gt;
                        &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;
                        &lt;version&gt;${elasticsearch.version}&lt;/version&gt;
                        &lt;type&gt;zip&lt;/type&gt;
                    &lt;/artifactItem&gt;
                &lt;/artifactItems&gt;
                &lt;useBaseVersion&gt;true&lt;/useBaseVersion&gt;
                &lt;outputDirectory&gt;${project.build.directory}/integration-tests/binaries&lt;/outputDirectory&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>
<p>This will get elasticsearch from you <code>.m2</code> local repository and if not available, it will downloaded from Maven central first.</p>
<h3 id=launch-ant-script>Launch ANT script</h3>
<p>You can use Maven ant plugin:</p>
<pre><code class=language-xml>&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-antrun-plugin&lt;/artifactId&gt;
    &lt;version&gt;1.8&lt;/version&gt;
    &lt;executions&gt;
        &lt;!-- start up external cluster --&gt;
        &lt;execution&gt;
            &lt;id&gt;integ-setup&lt;/id&gt;
            &lt;phase&gt;pre-integration-test&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;run&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
                &lt;skip&gt;${skipIntegTests}&lt;/skip&gt;
                &lt;target&gt;
                    &lt;ant antfile=&quot;src/test/ant/integration-tests.xml&quot; target=&quot;start-external-cluster-with-plugin&quot;/&gt;
                &lt;/target&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
        &lt;!-- shut down external cluster --&gt;
        &lt;execution&gt;
            &lt;id&gt;integ-teardown&lt;/id&gt;
            &lt;phase&gt;post-integration-test&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;run&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
                &lt;skip&gt;${skipIntegTests}&lt;/skip&gt;
                &lt;target&gt;
                    &lt;ant antfile=&quot;src/test/ant/integration-tests.xml&quot; target=&quot;stop-external-cluster&quot;/&gt;
                &lt;/target&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>
<p>It will launch here the <code>start-external-cluster-with-plugin</code> task during before integration tests and <code>stop-external-cluster</code> after integration tests.</p>
<h3 id=separate-integration-tests-and-unit-tests>Separate integration tests and unit tests</h3>
<p>As I&rsquo;m using the Randomized testing framework, here is what I wrote.</p>
<p>First, I&rsquo;m disabling Maven surefire plugin:</p>
<pre><code class=language-xml>&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.19&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;default-test&lt;/id&gt;
            &lt;phase&gt;none&lt;/phase&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>
<p>Then, I configure the randomizedtesting plugin:</p>
<pre><code class=language-xml>&lt;plugin&gt;
    &lt;groupId&gt;com.carrotsearch.randomizedtesting&lt;/groupId&gt;
    &lt;artifactId&gt;junit4-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.3.3&lt;/version&gt;

    &lt;configuration&gt;
        &lt;assertions enableSystemAssertions=&quot;false&quot;&gt;
            &lt;enable/&gt;
        &lt;/assertions&gt;

        &lt;listeners&gt;
            &lt;report-text /&gt;
        &lt;/listeners&gt;
    &lt;/configuration&gt;

    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;unit-tests&lt;/id&gt;
            &lt;phase&gt;test&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;junit4&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;inherited&gt;true&lt;/inherited&gt;
            &lt;configuration&gt;
                &lt;skipTests&gt;${skipUnitTests}&lt;/skipTests&gt;
                &lt;includes&gt;
                    &lt;include&gt;**/*Test.class&lt;/include&gt;
                &lt;/includes&gt;
                &lt;excludes&gt;
                    &lt;exclude&gt;**/*$*&lt;/exclude&gt;
                &lt;/excludes&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
        &lt;execution&gt;
            &lt;id&gt;integration-tests&lt;/id&gt;
            &lt;phase&gt;integration-test&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;junit4&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;inherited&gt;true&lt;/inherited&gt;
            &lt;configuration&gt;
                &lt;skipTests&gt;${skipIntegTests}&lt;/skipTests&gt;
                &lt;includes&gt;
                    &lt;include&gt;**/*IT.class&lt;/include&gt;
                &lt;/includes&gt;
                &lt;excludes&gt;
                    &lt;exclude&gt;**/*$*&lt;/exclude&gt;
                &lt;/excludes&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>
<p>You can see in the configuration that tests with name ending with <code>Test</code> are considered as unit tests.
Tests ending with <code>IT</code> will be launched only during integration tests phase. Note that we skip the tests
depending on <code>skipUnitTests</code> and <code>skipIntegTests</code>.</p>
<p>So running something like:</p>
<pre><code class=language-sh>mvn clean install -DskipUnitTests
</code></pre>
<p>Will only launch integration tests.</p>
<h3 id=adding-profiles-for-1x-and-2x>Adding profiles for 1.x and 2.x</h3>
<p>You can use Maven profiles to be able to test any version you wish.
I choose to test only the latest version of each major branch:</p>
<pre><code class=language-xml>&lt;profiles&gt;
    &lt;profile&gt;
        &lt;id&gt;es-1x&lt;/id&gt;
        &lt;properties&gt;
            &lt;elasticsearch.groupid&gt;org.elasticsearch&lt;/elasticsearch.groupid&gt;
            &lt;elasticsearch.version&gt;1.7.5&lt;/elasticsearch.version&gt;
        &lt;/properties&gt;
    &lt;/profile&gt;
    &lt;profile&gt;
        &lt;id&gt;es-2x&lt;/id&gt;
        &lt;properties&gt;
            &lt;elasticsearch.groupid&gt;org.elasticsearch.distribution.zip&lt;/elasticsearch.groupid&gt;
            &lt;elasticsearch.version&gt;2.3.3&lt;/elasticsearch.version&gt;
        &lt;/properties&gt;
    &lt;/profile&gt;
&lt;/profiles&gt;
</code></pre>
<p>When you want to test against 5.x, just run:</p>
<pre><code class=language-sh>mvn clean install
</code></pre>
<p>To test against 2.x, run:</p>
<pre><code class=language-sh>mvn clean install -Pes-2x
</code></pre>
<p>To test against 1.x, run:</p>
<pre><code class=language-sh>mvn clean install -Pes-1x
</code></pre>
<blockquote>
<p>This is theorical as for example the test framework does not exist in 1.7 and plugins from 2.0 must
match the exact version they have built for.
But if you are building a standalone application and want to test your application, this is the
way to go. This is exactly what I did for <a href=https://github.com/dadoonet/fscrawler>FSCrawler project</a>.</p>
</blockquote>
<h2 id=write-integration-tests>Write Integration tests</h2>
<h3 id=add-elasticsearch-rest-client>Add Elasticsearch REST Client</h3>
<p>Elasticsearch 5.0.0 comes with a new low level REST client.
We can use it to run our tests:</p>
<pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
    &lt;artifactId&gt;rest&lt;/artifactId&gt;
    &lt;version&gt;${elasticsearch.version}&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id=skip-tests-if-no-cluster>Skip tests if no cluster</h3>
<p>When we run from the IDE, we don&rsquo;t want to fail our tests because we did not start
an external cluster.</p>
<p>Let&rsquo;s build an abstract class for all our Integration tests:</p>
<pre><code class=language-java>public abstract class AbstractITCase extends ESTestCase {
    protected static final ESLogger staticLogger = ESLoggerFactory.getLogger(&quot;it&quot;);
    protected final static int HTTP_TEST_PORT = 9400;
    protected static RestClient client;

    @BeforeClass
    public static void startRestClient() {
        client = RestClient.builder(new HttpHost(&quot;localhost&quot;, HTTP_TEST_PORT)).build();
        try {
            Response response = client.performRequest(&quot;GET&quot;, &quot;/&quot;);
            Map&lt;String, Object&gt; responseMap = entityAsMap(response);
            assertThat(responseMap, hasEntry(&quot;tagline&quot;, &quot;You Know, for Search&quot;));
            staticLogger.info(&quot;Integration tests ready to start... Cluster is running.&quot;);
        } catch (IOException e) {
            // If we have an exception here, let's ignore the test
            staticLogger.warn(&quot;Integration tests are skipped: [{}]&quot;, e.getMessage());
            assumeThat(&quot;Integration tests are skipped&quot;, e.getMessage(), not(containsString(&quot;Connection refused&quot;)));
            staticLogger.error(&quot;Full error is&quot;, e);
            fail(&quot;Something wrong is happening. REST Client seemed to raise an exception.&quot;);
        }
    }

    @AfterClass
    public static void stopRestClient() throws IOException {
        if (client != null) {
            client.close();
            client = null;
        }
        staticLogger.info(&quot;Stopping integration tests against an external cluster&quot;);
    }
}
</code></pre>
<p>This class test before launching any test that a cluster is running on port <code>9400</code>.
If not, <code>assumeThat()</code> method will simply mark the test as ignored.</p>
<h3 id=our-first-integration-test>Our first integration test</h3>
<p>We want to test that the plugin is actually loaded. So we call the <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-nodes-info.html>Nodes Info API</a>.</p>
<pre><code class=language-java>public class BanoPluginIT extends AbstractITCase {

    public void testPluginIsLoaded() throws Exception {

        Response response = client.performRequest(&quot;GET&quot;, &quot;/_nodes/plugins&quot;);

        Map&lt;String, Object&gt; nodes = (Map&lt;String, Object&gt;) entityAsMap(response).get(&quot;nodes&quot;);
        for (String nodeName : nodes.keySet()) {
            boolean pluginFound = false;
            Map&lt;String, Object&gt; node = (Map&lt;String, Object&gt;) nodes.get(nodeName);
            List&lt;Map&lt;String, Object&gt;&gt; plugins = (List&lt;Map&lt;String, Object&gt;&gt;) node.get(&quot;plugins&quot;);
            for (Map&lt;String, Object&gt; plugin : plugins) {
                String pluginName = (String) plugin.get(&quot;name&quot;);
                if (pluginName.equals(&quot;ingest-bano&quot;)) {
                    pluginFound = true;
                    break;
                }
            }
            assertThat(pluginFound, is(true));
        }
    }
}
</code></pre>
<h3 id=run-the-tests>Run the tests</h3>
<p>Just start <code>mvn install</code> and let Maven do all the job!</p>
<pre><code class=language-sh>$ mvn install
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Plugin: Ingest: BANO 5.0.0-alpha5-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ ingest-bano ---
[INFO] Copying 0 resource
[INFO]
[INFO] --- maven-compiler-plugin:3.3:compile (default-compile) @ ingest-bano ---
[INFO] Nothing to compile - all classes are up to date
[INFO]
[INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ ingest-bano ---
[INFO] Copying 1 resource
[INFO]
[INFO] --- maven-compiler-plugin:3.3:testCompile (default-testCompile) @ ingest-bano ---
[INFO] Nothing to compile - all classes are up to date
[INFO]
[INFO] --- junit4-maven-plugin:2.3.3:junit4 (unit-tests) @ ingest-bano ---
[INFO] &lt;JUnit4&gt; says ahoj! Master seed: 9C880DFF84F2A5FD
Executing 1 suite with 1 JVM.

# UNIT TESTS HERE

Completed [1/1] in 4.18s, 1 test

[INFO] JVM J0:     0.65 ..     5.47 =     4.82s
[INFO] Execution time total: 5.47 sec.
[INFO] Tests summary: 1 suite, 1 test
[INFO]
[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ ingest-bano ---
[INFO]
[INFO] --- maven-assembly-plugin:2.6:single (default) @ ingest-bano ---
[INFO] Reading assembly descriptor: /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/src/main/assemblies/plugin.xml
[INFO] Building zip: /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/releases/ingest-bano-5.0.0-alpha5-SNAPSHOT.zip
[INFO]
[INFO] --- maven-dependency-plugin:2.10:copy (integ-setup-dependencies) @ ingest-bano ---
[INFO] Configured Artifact: org.elasticsearch.distribution.zip:elasticsearch:5.0.0-alpha5:zip
[INFO] org.elasticsearch.distribution.zip:elasticsearch:5.0.0-alpha5:zip already exists in /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/binaries
[INFO]
[INFO] --- maven-antrun-plugin:1.8:run (integ-setup) @ ingest-bano ---
[INFO] Executing tasks

main:

stop-external-cluster:

setup-workspace:
   [delete] Deleting directory /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/run
    [unzip] Expanding: /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/binaries/elasticsearch-5.0.0-alpha5.zip into /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/run

start-external-cluster-with-plugin:
     [echo] Installing plugin ingest-bano...
    [mkdir] Created dir: /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/run/tmp/null463372788
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;exec script=&quot;elasticsearch-plugin&quot;&gt;
  &lt;arg value=&quot;install&quot; /&gt;
  &lt;arg value=&quot;file:/Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/releases/ingest-bano-5.0.0-alpha5.zip&quot; /&gt;
&lt;/exec&gt;
[elasticsearch-plugin] Plugins directory [/Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/run/elasticsearch-5.0.0-alpha5/plugins] does not exist. Creating...
[elasticsearch-plugin] -&gt; Downloading file:/Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/releases/ingest-bano-5.0.0-alpha5-SNAPSHOT.zip
[elasticsearch-plugin]
[elasticsearch-plugin] -&gt; Installed ingest-bano
     [echo] Starting up external cluster...
     [echo] running Elasticsearch 5.0.0 or superior
    [mkdir] Created dir: /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/run/tmp/null353022298
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;exec script=&quot;elasticsearch&quot;&gt;
  &lt;arg value=&quot;-Epidfile=/Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/run/es.pid&quot; /&gt;
  &lt;arg value=&quot;-Ecluster.name=elasticsearch_integration&quot; /&gt;
  &lt;arg value=&quot;-Ehttp.port=9400&quot; /&gt;
  &lt;arg value=&quot;-Etransport.tcp.port=9500&quot; /&gt;
  &lt;arg value=&quot;-Enetwork.host=127.0.0.1&quot; /&gt;
&lt;/exec&gt;
     [echo] Waiting for elasticsearch to become available on port 9400...
[elasticsearch] [2016-07-29 01:54:01,457][INFO ][node                     ] [] initializing ...
[elasticsearch] [2016-07-29 01:54:01,526][INFO ][env                      ] [GTlhLM8] using [1] data paths, mounts [[/ (/dev/disk1)]], net usable_space [24.1gb], net total_space [464.7gb], spins? [unknown], types [hfs]
[elasticsearch] [2016-07-29 01:54:01,526][INFO ][env                      ] [GTlhLM8] heap size [1.9gb], compressed ordinary object pointers [true]
[elasticsearch] [2016-07-29 01:54:01,527][INFO ][node                     ] [GTlhLM8] node name [GTlhLM8] derived from node ID; set [node.name] to override
[elasticsearch] [2016-07-29 01:54:01,528][INFO ][node                     ] [GTlhLM8] version[5.0.0-alpha5], pid[2942], build[0d2ccf0/2016-07-28T15:02:31.650Z], OS[Mac OS X/10.11.5/x86_64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_60/25.60-b23]
[elasticsearch] [2016-07-29 01:54:02,442][INFO ][io.netty.util.internal.PlatformDependent] Your platform does not provide complete low-level API for accessing direct buffers reliably. Unless explicitly requested, heap buffer will always be preferred to avoid potential system unstability.
[elasticsearch] [2016-07-29 01:54:02,472][INFO ][plugins                  ] [GTlhLM8] loaded module [aggs-matrix-stats]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [ingest-common]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [lang-expression]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [lang-groovy]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [lang-mustache]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [lang-painless]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [percolator]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [reindex]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [transport-netty3]
[elasticsearch] [2016-07-29 01:54:02,473][INFO ][plugins                  ] [GTlhLM8] loaded module [transport-netty4]
[elasticsearch] [2016-07-29 01:54:02,475][INFO ][plugins                  ] [GTlhLM8] loaded plugin [ingest-bano]
[elasticsearch] [2016-07-29 01:54:04,280][INFO ][node                     ] [GTlhLM8] initialized
[elasticsearch] [2016-07-29 01:54:04,280][INFO ][node                     ] [GTlhLM8] starting ...
[elasticsearch] [2016-07-29 01:54:04,374][INFO ][transport                ] [GTlhLM8] publish_address {127.0.0.1:9500}, bound_addresses {127.0.0.1:9500}
[elasticsearch] [2016-07-29 01:54:04,384][WARN ][bootstrap                ] [GTlhLM8] initial heap size [268435456] not equal to maximum heap size [2147483648]; this can cause resize pauses and prevents mlockall from locking the entire heap
[elasticsearch] [2016-07-29 01:54:04,384][WARN ][bootstrap                ] [GTlhLM8] please set [discovery.zen.minimum_master_nodes] to a majority of the number of master eligible nodes in your cluster
[elasticsearch] [2016-07-29 01:54:07,442][INFO ][cluster.service          ] [GTlhLM8] new_master {GTlhLM8}{GTlhLM8vRK2YltPhlJOgTA}{C2ab3gH0S9OonOtQNbkmxw}{127.0.0.1}{127.0.0.1:9500}, reason: zen-disco-elected-as-master ([0] nodes joined)
[elasticsearch] [2016-07-29 01:54:07,453][INFO ][http                     ] [GTlhLM8] publish_address {127.0.0.1:9400}, bound_addresses {127.0.0.1:9400}
[elasticsearch] [2016-07-29 01:54:07,453][INFO ][node                     ] [GTlhLM8] started
[elasticsearch] [2016-07-29 01:54:07,461][INFO ][gateway                  ] [GTlhLM8] recovered [0] indices into cluster_state
     [echo] External node started PID 2942
[INFO] Executed tasks
[INFO]
[INFO] --- junit4-maven-plugin:2.3.3:junit4 (integration-tests) @ ingest-bano ---
[INFO] &lt;JUnit4&gt; says jolly good day! Master seed: 781C148F31C34F3D
Executing 1 suite with 1 JVM.

Started J0 PID(2958@MacBook-Pro-4.local).
Suite: org.elasticsearch.ingest.bano.BanoPluginIT
  1&gt; [2016-07-29 01:54:08,648][WARN ][org.elasticsearch.bootstrap] Unable to lock JVM Memory: error=78, reason=Function not implemented
  1&gt; [2016-07-29 01:54:08,649][WARN ][org.elasticsearch.bootstrap] This can result in part of the JVM being swapped out.
  1&gt; [2016-07-29 01:54:09,496][INFO ][it                       ] Integration tests ready to start... Cluster is running.
OK      0.10s | BanoPluginIT.testPluginIsLoaded
  1&gt; [2016-07-29 01:54:09,603][INFO ][it                       ] Stopping integration tests against an external cluster
Completed [1/1] in 1.22s, 1 test

[INFO] JVM J0:     0.27 ..     2.04 =     1.77s
[INFO] Execution time total: 2.05 sec.
[INFO] Tests summary: 1 suite, 1 test
[INFO]
[INFO] --- maven-antrun-plugin:1.8:run (integ-teardown) @ ingest-bano ---
[INFO] Executing tasks

main:

stop-external-cluster:
     [echo] Shutting down external node PID 2942
   [delete] Deleting: /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/integration-tests/run/es.pid
[INFO] Executed tasks
[INFO]
[INFO] --- maven-install-plugin:2.4:install (default-install) @ ingest-bano ---
[INFO] Installing /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/ingest-bano-5.0.0-alpha5-SNAPSHOT.jar to /Users/dpilato/.m2/repository/fr/pilato/elasticsearch/ingest/ingest-bano/5.0.0-alpha5-SNAPSHOT/ingest-bano-5.0.0-alpha5-SNAPSHOT.jar
[INFO] Installing /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/pom.xml to /Users/dpilato/.m2/repository/fr/pilato/elasticsearch/ingest/ingest-bano/5.0.0-alpha5-SNAPSHOT/ingest-bano-5.0.0-alpha5-SNAPSHOT.pom
[INFO] Installing /Users/dpilato/Documents/Elasticsearch/dev/blog-tests/ingest-bano/target/releases/ingest-bano-5.0.0-alpha5-SNAPSHOT.zip to /Users/dpilato/.m2/repository/fr/pilato/elasticsearch/ingest/ingest-bano/5.0.0-alpha5-SNAPSHOT/ingest-bano-5.0.0-alpha5-SNAPSHOT.zip
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 22.102 s
[INFO] Finished at: 2016-07-29T01:54:10+02:00
[INFO] Final Memory: 31M/545M
[INFO] ------------------------------------------------------------------------
</code></pre>
<p>You can see at the end the execution of integration tests from this line:</p>
<p><code>[INFO] --- junit4-maven-plugin:2.3.3:junit4 (integration-tests) @ ingest-bano ---</code></p>
<p>Done!</p>
</div>
<div class=my-4>
<a href=https://david.pilato.fr/tags/java/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#java</a>
<a href=https://david.pilato.fr/tags/maven/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#maven</a>
<a href=https://david.pilato.fr/tags/ant/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#ant</a>
<a href=https://david.pilato.fr/tags/test/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#test</a>
<a href=https://david.pilato.fr/tags/elasticsearch/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#elasticsearch</a>
<a href=https://david.pilato.fr/tags/plugin/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#plugin</a>
</div>
<div class="flex md:justify-end my-4">
<style>#share-buttons{display:inline-block;vertical-align:middle}#share-buttons:after{content:"";display:block;clear:both}#share-buttons>div{position:relative;text-align:left;height:36px;width:32px;float:left;text-align:center}#share-buttons>div>svg{height:16px;fill:#000;margin-top:10px}#share-buttons>div:hover{cursor:pointer}#share-buttons>div.facebook:hover>svg{fill:#3b5998}#share-buttons>div.twitter:hover>svg{fill:#55acee}#share-buttons>div.linkedin:hover>svg{fill:#0077b5}#share-buttons>div.pinterest:hover>svg{fill:#cb2027}#share-buttons>div.mail:hover>svg{fill:#7d7d7d}#share-buttons>div.facebook>svg{height:18px;margin-top:9px}#share-buttons>div.twitter>svg{height:20px;margin-top:8px}#share-buttons>div.linkedin>svg{height:19px;margin-top:7px}#share-buttons>div.pinterest>svg{height:20px;margin-top:9px}#share-buttons>div.mail>svg{height:14px;margin-top:11px}</style>
<div id=share-buttons>
<div class=facebook title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https://david.pilato.fr/blog/2016-07-29-elasticsearch-real-integration-tests/')"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759H734V905H479V609h255V391q0-186 104-288.5T1115 0q147 0 228 12z"/></svg></div>
<div class=twitter title="Share this on Twitter" onclick="window.open('http://twitter.com/intent/tweet?via=dadoonet&text=🧑🏼‍💻%20Blog:%20Elasticsearch real integration tests%20👉🏼&url=https://david.pilato.fr/blog/2016-07-29-elasticsearch-real-integration-tests/')"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
<div class=linkedin title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https://david.pilato.fr/blog/2016-07-29-elasticsearch-real-integration-tests/&title=&summary=&source=')"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991H147V625h330zm21-306q1 73-50.5 122T312 490h-2q-82 0-132-49t-50-122q0-74 51.5-122.5T314 148t133 48.5T498 319zm1166 729v568h-329v-530q0-105-40.5-164.5T1168 862q-63 0-105.5 34.5T999 982q-11 30-11 81v553H659q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5T1285 602q171 0 275 113.5t104 332.5z"/></svg></div>
<div class=mail title="Share this through Email" onclick="window.open('mailto:?&body=https://david.pilato.fr/blog/2016-07-29-elasticsearch-real-integration-tests/')"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47H160q-66 0-113-47T0 1504V710q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 1e2-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38T639 1015q-91-64-262-182.5T172 690q-62-42-117-115.5T0 438q0-78 41.5-130T160 256h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>
<a href=https://github.com/dadoonet/dadoonet.github.io/tree/main/content/blog/2016-07-29-elasticsearch-real-integration-tests/index.md title="Edit this page">
<i class="fas fa-edit mr-1"></i>
</a>
</div>
<div class=py-2>
<div class="flex flex-col md:flex-row items-center my-8">
<a href=https://david.pilato.fr/authors/david-pilato/ class="w-24 h-24 md:mr-4">
<img src=https://david.pilato.fr/authors/david-pilato/david_pilato.png class="w-full bg-primary-bg rounded-full" alt=Avatar>
</a>
<div class="w-full md:w-auto mt-4 md:mt-0">
<a href=https://david.pilato.fr/authors/david-pilato/ class="block font-bold text-lg pb-1 mb-2 border-b">David Pilato</a>
<span class="block pb-2">20+ years of experience, mostly in Java. Living in Cergy, France.</span>
<a href=mailto:david+blog@pilato.fr class=mr-1>
<i class="fas fa-envelope"></i>
</a>
<a href=https://twitter.com/dadoonet class=mr-1>
<i class="fab fa-twitter"></i>
</a>
<a href=https://github.com/dadoonet class=mr-1>
<i class="fab fa-github"></i>
</a>
<a href=https://www.linkedin.com/in/dadoonet/ class=mr-1>
<i class="fab fa-linkedin"></i>
</a>
</div>
</div>
</div>
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
<div>
<span class="block font-bold">Previous</span>
<a href=https://david.pilato.fr/blog/2016-07-30-adding-a-new-rest-endpoint-to-elasticsearch/ class=block>Adding a new REST endpoint to elasticsearch</a>
</div>
<div class="md:text-right mt-4 md:mt-0">
<span class="block font-bold">Next</span>
<a href=https://david.pilato.fr/blog/2016-07-28-creating-an-ingest-plugin-for-elasticsearch/ class=block>Creating an Ingest plugin for elasticsearch</a>
</div>
</div>
<script id=utterances src=https://utteranc.es/client.js issue-term=pathname label=💬 comments repo=dadoonet/dadoonet.github.io theme=preferred-color-scheme crossorigin=anonymous async></script>
<script>storageColorScheme=="Light"?document.getElementById('utterances').setAttribute('theme','github-light'):storageColorScheme=="Dark"&&document.getElementById('utterances').setAttribute('theme','github-dark')</script>
</div>
<div class=col-span-2>
<div class="bg-secondary-bg rounded p-6">
<h3 class="text-lg font-semibold mb-4">Series of Posts</h3>
<div class=content>
<a href=https://david.pilato.fr/blog/2016-08-03-elasticsearch-real-integration-tests-with-security-enabled/>Elasticsearch real integration tests with security enabled</a>
<br>
<a href=https://david.pilato.fr/blog/2016-08-01-creating-elasticsearch-transport-action/>Creating Elasticsearch Transport Action</a>
<br>
<a href=https://david.pilato.fr/blog/2016-07-30-adding-a-new-rest-endpoint-to-elasticsearch/>Adding a new REST endpoint to elasticsearch</a>
<br>
<a href=https://david.pilato.fr/blog/2016-07-29-elasticsearch-real-integration-tests/>Elasticsearch real integration tests</a>
<br>
<a href=https://david.pilato.fr/blog/2016-07-28-creating-an-ingest-plugin-for-elasticsearch/>Creating an Ingest plugin for elasticsearch</a>
<br>
<a href=https://david.pilato.fr/blog/2016-07-27-creating-a-plugin-for-elasticsearch-5-dot-0-using-maven/>Creating a plugin for elasticsearch 5.0 using Maven</a>
<br>
</div>
</div>
<div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-primary-bg">
<span class="text-lg font-semibold">On This Page</span>
</div>
<div class="sticky-toc hidden lg:block px-6 pb-6">
<nav id=TableOfContents>
<ul>
<li><a href=#how-do-we-want-to-test>How do we want to test?</a>
<ul>
<li><a href=#separated-skiptests>Separated skipTests</a></li>
<li><a href=#writing-a-ant-script>Writing a ANT script</a></li>
<li><a href=#download-elasticsearch>Download elasticsearch</a></li>
<li><a href=#launch-ant-script>Launch ANT script</a></li>
<li><a href=#separate-integration-tests-and-unit-tests>Separate integration tests and unit tests</a></li>
<li><a href=#adding-profiles-for-1x-and-2x>Adding profiles for 1.x and 2.x</a></li>
</ul>
</li>
<li><a href=#write-integration-tests>Write Integration tests</a>
<ul>
<li><a href=#add-elasticsearch-rest-client>Add Elasticsearch REST Client</a></li>
<li><a href=#skip-tests-if-no-cluster>Skip tests if no cluster</a></li>
<li><a href=#our-first-integration-test>Our first integration test</a></li>
<li><a href=#run-the-tests>Run the tests</a></li>
</ul>
</li>
</ul>
</nav>
</div>
<script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc()})</script>
</div>
<div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded p-6">
<h2 class="text-lg font-semibold mb-4">See Also</h2>
<div class=content>
<a href=https://david.pilato.fr/blog/2016-07-28-creating-an-ingest-plugin-for-elasticsearch/>Creating an Ingest plugin for elasticsearch</a>
<br>
<a href=https://david.pilato.fr/blog/2016-07-27-creating-a-plugin-for-elasticsearch-5-dot-0-using-maven/>Creating a plugin for elasticsearch 5.0 using Maven</a>
<br>
<a href=https://david.pilato.fr/blog/2011-09-14-mon-premier-plugin-elasticsearch-rss-river/>Mon premier plugin elasticsearch : RSS River</a>
<br>
<a href=https://david.pilato.fr/blog/2012-05-25-la-factory-spring-pour-elasticsearch-est-sortie/>La factory Spring pour Elasticsearch est sortie !</a>
<br>
<a href=https://david.pilato.fr/blog/2012-04-02-une-factory-spring-pour-elasticsearch/>Une factory Spring pour Elasticsearch</a>
<br>
<a href=https://david.pilato.fr/blog/2012-02-13-quel-client-java-pour-elasticsearch/>Quel client Java pour elasticsearch ?</a>
<br>
</div>
</div>
</div>
<script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script>
</div>
</div>
</main>
<footer class=pl-scrollbar>
<div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
<p class="text-sm text-tertiary-text">&copy; 2022, David Pilato, France
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p>
</div></div>
</footer>
</body>
</html>